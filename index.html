<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Noche de EsTragos</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e6c229">
<link rel="icon" href="icon-192x192.png">

<!-- Para iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Es Tragos">
<link rel="apple-touch-icon" href="icon-192x192.png">

<style>
/* Evitar pull-to-refresh en dispositivos móviles */
html, body {
  overscroll-behavior: none;
  touch-action: manipulation;
  overflow-x: hidden;
}

#app {
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
  
  overflow-x: hidden;
}
/* ── VARIABLES DE TEMA ACTUALIZADAS ───────────────────────────────── */
:root {
  --bg: #0a0a12;
  --card-bg: rgba(18, 18, 30, 0.85);
  --accent-red: #ff3860;
  --accent-gold: #e6c229;
  --accent-blue: #3298dc;
  --accent-purple: #9b59b6;
  --accent-green: #4cd964;
  --text: #f0f0ff;
  --muted: #aaa;
  --role-good: #4cd964;
  --role-bad: #ff3860;
  --role-neutral: #ffdd57;
  --shadow: 0 8px 24px rgba(0, 0, 0, 0.7);
  --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  --glass-bg: rgba(30, 30, 45, 0.6);
  --border-gradient: linear-gradient(90deg, #ffd700, #e6c229, #ffd700);
  --border-radius: 20px;
  --box-shadow: 0 16px 40px rgba(0, 0, 0, 0.5);
}

/* ── ESTILOS GLOBALES ACTUALIZADAS ───────────────────────────────── */
* { 
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Montserrat', sans-serif;
  background: 
  radial-gradient(circle at 30% 30%, rgba(26,26,46,0.6), rgba(26,26,46,0.6)),
  url('img/fondo6.png') center/cover no-repeat fixed;
  color: var(--text);
  min-height: 100vh;
  padding: 1rem;
  line-height: 1.6;
  overflow-x: hidden;
  
}

#app {
  max-width: 500px;
  margin: 0 auto;
  padding: 1rem;
  
}

/* Nuevos estilos para la sección de instrucciones mejorada */

.instructions-container {
  max-width: 700px;
  margin: 0 auto;
  padding: 10px;
}

.instructions-section {
  background: rgba(18, 18, 30, 0.85);
  border-radius: 20px;
  padding: 25px;
  margin-bottom: 25px;
  box-shadow: 0 16px 40px rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(230, 194, 41, 0.3);
}

.instructions-section h2 {
  font-family: 'Cinzel Decorative', cursive;
  color: var(--accent-gold);
  text-align: center;
  margin-bottom: 20px;
  font-size: 1.8rem;
  position: relative;
}

.instructions-section h2::after {
  content: '';
  display: block;
  width: 80px;
  height: 3px;
  background: var(--border-gradient);
  margin: 10px auto;
  border-radius: 3px;
}

.instructions-content {
  line-height: 1.7;
}

.instruction-steps {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin: 25px 0;
}

.instruction-step {
  flex: 1;
  min-width: 250px;
  background: rgba(30, 30, 45, 0.6);
  border-radius: 12px;
  padding: 20px;
  border-left: 4px solid var(--accent-gold);
}

.instruction-step h3 {
  color: var(--accent-gold);
  margin-top: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.instruction-step h3 i {
  font-size: 1.5rem;
}

.role-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.role-card {
  background: rgba(30, 30, 45, 0.6);
  border-radius: 12px;
  padding: 15px;
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.role-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
}

.role-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.role-icon {
  font-size: 1.8rem;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.3);
}

.role-title {
  font-weight: 600;
  font-size: 1.2rem;
}

.role-alignment {
  font-size: 0.85rem;
  padding: 3px 8px;
  border-radius: 12px;
  margin-left: 8px;
}

.role-good .role-alignment { background: rgba(76, 217, 100, 0.2); color: var(--role-good); }
.role-bad .role-alignment { background: rgba(255, 56, 96, 0.2); color: var(--role-bad); }
.role-neutral .role-alignment { background: rgba(255, 221, 87, 0.2); color: var(--role-neutral); }

.role-description {
  font-size: 0.95rem;
  line-height: 1.6;
  color: white;
}

.difficulty-cards {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-top: 20px;
}

.difficulty-card {
  flex: 1;
  min-width: 250px;
  border-radius: 15px;
  padding: 20px;
  background: rgba(30, 30, 45, 0.7);
  border: 1px solid;
  transition: transform 0.3s ease;
}

.difficulty-card:hover {
  transform: scale(1.03);
}

.difficulty-card.pussy { border-color: var(--accent-blue); }
.difficulty-card.girls { border-color: var(--accent-purple); }
.difficulty-card.alcoholico { border-color: var(--accent-red); }

.drink-rules {
  margin-top: 15px;
}

.drink-rule {
  display: flex;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
  align-items: center;
  gap: 10px;
}

.drink-rule-icon {
  font-size: 1.3rem;
  min-width: 30px;
  text-align: center;
}

.drink-rule-text {
  flex: 1;
}

.phase-diagram {
  display: flex;
  justify-content: center;
  margin: 30px 0;
  gap: 20px;
  flex-wrap: wrap;
}

.phase-card {
  width: 200px;
  padding: 20px;
  text-align: center;
  border-radius: 15px;
  background: rgba(30, 30, 45, 0.7);
  border: 1px solid;
}

.phase-card.night {
  border-color: var(--accent-purple);
}

.phase-card.day {
  border-color: var(--accent-gold);
}

.phase-icon {
  font-size: 2.5rem;
  margin-bottom: 15px;
}

.phase-title {
  font-weight: bold;
  margin-bottom: 10px;
  font-size: 1.2rem;
}

.phase-steps {
  text-align: left;
  font-size: 0.9rem;
}

.phase-steps li {
  margin-bottom: 8px;
}

.back-button-container {
  text-align: center;
  margin-top: 30px;
}

/* ── TIPOGRAFÍA ACTUALIZADA ─────────────────────────────────────── */
h1, h2, h3 {
  font-family: 'Cinzel Decorative', cursive;
  text-align: center;
  margin: 0.5rem 0 1rem;
  letter-spacing: 1px;
  font-weight: 900;
}

h1 {
  font-size: 2.8rem;
  background: linear-gradient(45deg, var(--accent-gold), #ffd700);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  margin-bottom: 1.5rem;
  position: relative;
  padding-bottom: 15px;
}

h1::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 150px;
  height: 4px;
  background: var(--border-gradient);
  border-radius: 2px;
}

h2 {
  font-size: 1.8rem;
  color: var(--accent-gold);
  margin: 1.5rem 0;
  position: relative;
}

h2::after {
  content: '';
  display: block;
  width: 80px;
  height: 3px;
  background: var(--border-gradient);
  margin: 0.8rem auto;
  border-radius: 3px;
}

h3 {
  font-size: 1.4rem;
  color: var(--accent-blue);
  margin: 1rem 0;
}

p { 
  margin: 0.8rem 0;
  font-weight: 300;
  line-height: 1.7;
}

/* ── TARJETAS MODERNAS ──────────────────────────────────────────── */
.card {
  background: var(--card-bg);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(230, 194, 41, 0.3);
  border-radius: var(--border-radius);
  padding: 1.8rem;
  margin: 1.5rem 0;
  box-shadow: var(--box-shadow);
  animation: fadeIn 0.5s ease-out;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--border-gradient);
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.8);
}

.role-card {
  animation: zoomIn 0.6s ease-out;
  border-color: rgba(230, 194, 41, 0.5);
}

/* ── ANIMACIONES ─────────────────────────────────────────────── */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes zoomIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

@keyframes float {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
  100% { transform: translateY(0px); }
}

 /* Botones */
        button {
            width: 100%;
            padding: 1rem;
            margin: 0.8rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(45deg, #ff3860, #d7002b);
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.6s;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
        }

        button:hover::before {
            left: 100%;
        }

        button:active {
            transform: translateY(1px);
        }

        button.secondary {
            background: linear-gradient(45deg, #e6c229, #c5a400);
            color: #000;
        }

        button.secondary:hover {
            background: linear-gradient(45deg, #ffea00, #d4b800);
        }


        /* Carrusel */
        .carousel-container {
            position: relative;
            margin: 2rem 0;
            overflow: hidden;
            border-radius: 20px;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.7);
            height: 500px;
        }

        .carousel {
            display: flex;
            transition: transform 0.5s ease-in-out;
            height: 100%;
        }

        .carousel-item {
            min-width: 100%;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden;
            background: linear-gradient(to bottom, rgba(18, 18, 30, 0.9), rgba(18, 18, 30, 0.7));
        }

        .carousel-item.pussy {
            border: 3px solid #3298dc;
        }

        .carousel-item.girls {
            border: 3px solid #9b59b6;
        }

        .carousel-item.alcoholico {
            border: 3px solid #ff3860;
        }

        .carousel-image {
            width: 250px;
            height: 250px;
            object-fit: contain;
            margin-bottom: 1.5rem;
            filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.5));
            animation: float 6s ease-in-out infinite;
        }

        .carousel-title {
            font-family: 'Cinzel Decorative', cursive;
            font-size: 1.8rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #ffd700, #e6c229);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .carousel-description {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 1rem;
            max-width: 90%;
        }

        .carousel-drinks {
            font-size: 1.1rem;
            color: #fff;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .carousel-drinks strong {
            color: #e6c229;
            font-weight: 700;
        }

        .carousel-indicators {
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
            gap: 10px;
        }

        .carousel-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .carousel-indicator.active {
            background: #e6c229;
            transform: scale(1.2);
        }

        .carousel-controls {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            transform: translateY(-50%);
            padding: 0 1rem;
        }

        .carousel-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(230, 194, 41, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0a0a12;
            font-size: 1.2rem;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .carousel-btn:hover {
            transform: scale(1.1);
            background: #ffd700;
        }

        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(230, 194, 41, 0.5); }
            70% { box-shadow: 0 0 0 10px rgba(230, 194, 41, 0); }
            100% { box-shadow: 0 0 0 0 rgba(230, 194, 41, 0); }
        }

        /* Decoraciones */
        .background-decoration {
            position: fixed;
            z-index: -1;
            opacity: 0.05;
            font-size: 5rem;
            animation: float 6s infinite ease-in-out;
        }

        .decoration-1 { top: 10%; left: 5%; animation-delay: 0s; }
        .decoration-2 { top: 20%; right: 10%; animation-delay: 1s; }
        .decoration-3 { bottom: 15%; left: 15%; animation-delay: 2s; }
        .decoration-4 { bottom: 25%; right: 5%; animation-delay: 3s; }

        /* Responsive */
        @media (max-width: 500px) {
            
            .carousel-container {
                height: 380px;
            }
            
            .carousel-image {
                width: 150px;
                height: 150px;
            }
            
            .carousel-title {
                font-size: 1.5rem;
            }
            
            .carousel-description {
                font-size: 0.9rem;
            }
        }
        
        /* Estilos para el contenedor de burbujas */
.bubbles-container {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  z-index: -1;
  border-radius: 20px;
}

/* Estilos para cada burbuja */
.bubble {
  position: absolute;
  bottom: -100px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.1);
  animation: rise 10s infinite ease-in;
}

@keyframes rise {
  0% {
    bottom: -100px;
    transform: translateX(0);
  }
  50% {
    transform: translateX(100px);
  }
  100% {
    bottom: 100%;
    transform: translateX(-100px);
  }
}


/* ── LISTA DE JUGADORES MEJORADA ─────────────────────────────── */
.player-list {
  margin-top: 1.5rem;
  font-size: 1rem;
  background: var(--glass-bg);
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.player-list h4 {
  margin-top: 0;
  margin-bottom: 1rem;
  color: var(--accent-gold);
  text-align: center;
  font-size: 1.2rem;
}

.player-item {
  display: flex;
  justify-content: space-between;
  padding: 0.8rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  transition: var(--transition);
  align-items: center;
}

.player-item:hover {
  background: rgba(50, 50, 70, 0.4);
  border-radius: 8px;
}

.player-name {
  flex: 2;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
}

.player-status, .player-drinks {
  flex: 1;
  text-align: center;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}

.status-vivo { color: var(--role-good); }
.status-preso { color: var(--role-neutral); }
.status-eliminado { color: var(--role-bad); }

.player-drinks {
  color: var(--accent-gold);
}

.drink-icon {
  font-size: 1.2rem;
}

/* ── LOG DE EVENTOS MEJORADO ─────────────────────────────────── */
#eventLog {
  max-height: 180px;
  overflow-y: auto;
  background: rgba(20, 20, 30, 0.8);
  padding: 1rem;
  border-radius: 12px;
  margin-top: 1.5rem;
  font-size: 0.9rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.4);
  font-family: 'Courier New', monospace;
  line-height: 1.8;
}

.event-entry {
  padding: 0.5rem 0;
  border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
  animation: fadeIn 0.3s ease-out;
}

.event-entry:last-child {
  border-bottom: none;
}

/* ── SCROLL BAR PERSONALIZADO ───────────────────────────────── */
#eventLog::-webkit-scrollbar {
  width: 8px;
}

#eventLog::-webkit-scrollbar-thumb {
  background: var(--accent-gold);
  border-radius: 4px;
}

/* ── SELECCIÓN DE ROLES MEJORADA ────────────────────────────── */
.role-option { 
  margin: 12px 0; 
  display: flex;
  align-items: center;
}

.role-list { 
  display: grid; 
  grid-template-columns: repeat(2, 1fr); 
  gap: 10px;
  max-height: 220px;
  overflow-y: auto;
  padding: 12px;
  background: rgba(255, 255, 255, 0.08);
  border-radius: 12px;
  margin: 1.2rem 0;
}

.role-item {
  display: flex;
  align-items: center;
  padding: 8px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.05);
  transition: var(--transition);
  gap: 8px;
}

.role-item:hover {
  background: rgba(255, 255, 255, 0.1);
}

.role-item label {
  margin-left: 10px;
  cursor: pointer;
}

#roleCounter {
  text-align: center;
  margin: 12px 0;
  font-weight: 600;
  color: var(--accent-gold);
  font-size: 1.1rem;
}

/* ── INDICADORES DE ALINEACIÓN ─────────────────────────────── */
.role-good { color: var(--role-good); }
.role-bad { color: var(--role-bad); }
.role-neutral { color: var(--role-neutral); }

/* ── SECCIÓN DE TRAGOS MEJORADA ────────────────────────────── */
.drink-section {
  background: rgba(230, 194, 41, 0.08);
  border: 1px solid var(--accent-gold);
  border-radius: 12px;
  padding: 1.2rem;
  margin: 1.5rem 0;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.drink-section h3 {
  color: var(--accent-gold);
  margin-top: 0;
  text-align: center;
  font-size: 1.4rem;
}

.drink-list {
  padding-left: 0;
  list-style: none;
}

.drink-item {
  display: flex;
  align-items: center;
  padding: 0.8rem;
  margin: 0.5rem 0;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  transition: var(--transition);
  gap: 15px;
}

.drink-item:hover {
  background: rgba(0, 0, 0, 0.3);
}

.drink-icon-large {
  font-size: 1.8rem;
  color: var(--accent-gold);
  min-width: 30px;
  text-align: center;
}

.drink-text {
  flex: 1;
  font-size: 1rem;
}

/* ── TÍTULO PERSONALIZADO ──────────────────────────────────── */
.header-title {
  font-family: 'Cinzel Decorative', cursive;
  text-align: center;
  font-size: 2rem;
  margin: 0.5rem 0 1.5rem;
  background: linear-gradient(45deg, #ffd700, #e6c229);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  position: relative;
}

.header-title::after {
  content: '';
  position: absolute;
  bottom: -10px;
  left: 50%;
  transform: translateX(-50%);
  width: 100px;
  height: 3px;
  background: var(--border-gradient);
  border-radius: 2px;
}

/* ── PANTALLA DE SELECCIÓN ─────────────────────────────────── */
.role-selection-screen {
  display: flex;
  flex-direction: column;
  min-height: 80vh;
}

.role-selection-screen .card {
  flex: 1;
}

/* ── FORMULARIOS MEJORADOS ─────────────────────────────────── */
input[type="text"], input[type="number"], select {
  width: 100%;
  padding: 12px;
  font-size: 1.1rem;
  margin: 12px 0;
  background: rgba(20, 20, 30, 0.7);
  color: var(--text);
  border: 1px solid var(--accent-gold);
  border-radius: 12px;
  transition: var(--transition);
  font-family: 'Montserrat', sans-serif;
}

input[type="text"]:focus, input[type="number"]:focus, select:focus {
  outline: none;
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 2px rgba(50, 152, 220, 0.3);
}

/* ── EFECTO DE NEÓN ───────────────────────────────────────── */
.neon {
  
}

.neon-red {
  
}

/* ── CONTADOR DE TRAGOS EN JUGADOR ─────────────────────────── */
.drink-counter {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: rgba(230, 194, 41, 0.2);
  border-radius: 50%;
  width: 28px;
  height: 28px;
  margin-left: 8px;
  font-size: 0.9rem;
  font-weight: bold;
}

/* ── TABLA DE ROLES ───────────────────────────────────────── */
.role-table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
}

.role-table th, .role-table td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.role-table th {
  background: rgba(50, 50, 70, 0.4);
  color: var(--accent-gold);
}

.role-table input[type="number"] {
  width: 60px;
  text-align: center;
}

/* ── VOTACIÓN ASESINA ─────────────────────────────────────── */
.assassin-vote {
  background: rgba(255, 56, 96, 0.1);
  border: 1px solid var(--accent-red);
  border-radius: 12px;
  padding: 1rem;
  margin: 1.5rem 0;
  position: relative;
  overflow: hidden;
}

.assassin-vote::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent-red), transparent);
}

.assassin-vote h3 {
  color: var(--accent-red);
  margin-top: 0;
  text-align: center;
  font-family: 'Cinzel Decorative', cursive;
}

.vote-count {
  display: flex;
  justify-content: space-around;
  margin: 1rem 0;
  flex-wrap: wrap;
}

.vote-count div {
  text-align: center;
  padding: 0.8rem;
  border-radius: 8px;
  background: rgba(0, 0, 0, 0.3);
  margin: 0.3rem;
  min-width: 100px;
  flex: 1;
  border: 1px solid rgba(255, 56, 96, 0.3);
}

.vote-count div.selected {
  background: rgba(255, 56, 96, 0.2);
  border: 1px solid var(--accent-red);
  animation: pulse 1.5s infinite;
}

.vote-player {
  font-weight: bold;
  color: var(--accent-red);
  margin-bottom: 5px;
}

.vote-target {
  font-size: 1.1rem;
  font-weight: 600;
}

/* ── ELIMINACIÓN EFECTO ───────────────────────────────────── */
.eliminated {
  position: relative;
  padding: 0.5rem;
  border-radius: 8px;
  background: rgba(255, 56, 96, 0.1);
  margin: 0.5rem 0;
  border-left: 3px solid var(--accent-red);
}

.eliminated .role {
  font-weight: bold;
  color: var(--accent-red);
}

/* ── BADGE DE ROL ─────────────────────────────────────────── */
.role-badge {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-left: 8px;
  background: rgba(50, 50, 70, 0.5);
}

.role-badge.asesino {
  background: rgba(255, 56, 96, 0.2);
  color: var(--accent-red);
}

.role-badge.bueno {
  background: rgba(76, 217, 100, 0.2);
  color: var(--role-good);
}

.role-badge.hidratado {
  background: rgba(50, 152, 220, 0.2);
  color: var(--accent-blue);
}

.role-badge.neutral {
  background: rgba(255, 221, 87, 0.2);
  color: var(--role-neutral);
}

/* ── ESTILOS MEJORADOS PARA LA RULETA ─────────────── */
.ludopata-roulette {
  background: var(--glass-bg);
  border-radius: 16px;
  padding: 1.5rem;
  margin: 1.5rem 0;
  text-align: center;
  border: 2px solid var(--accent-gold);
  box-shadow: 0 0 20px rgba(230, 194, 41, 0.3);
}

.roulette-container {
  position: relative;
  height: 200px; /* Altura fija para mostrar 5 elementos */
  overflow: hidden;
  margin: 1rem 0;
  border-radius: 10px;
  background: rgba(0, 0, 0, 0.3);
  perspective: 1000px;
}

.roulette-wheel {
  position: absolute;
  width: 100%;
  transform-style: preserve-3d;
  transition: transform 4s cubic-bezier(0.2, 0.8, 0.2, 1);
}

.roulette-item {
  padding: 12px;
  text-align: center;
  font-weight: 500;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(0, 0, 0, 0.2);
  position: relative;
  transition: all 0.3s ease;
  height: 40px; /* Altura fija para cada elemento */
  line-height: 40px; /* Centrar texto verticalmente */
  overflow: hidden; /* Evitar desbordamiento */
  text-overflow: ellipsis; /* Texto largo */
  white-space: nowrap;
}

.roulette-item.winner {
  background: rgba(230, 194, 41, 0.3);
  border-left: 3px solid var(--accent-gold);
  border-right: 3px solid var(--accent-gold);
}

.roulette-result {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 40px;
  background: rgba(230, 194, 41, 0.3);
  z-index: 10;
  border-top: 2px solid var(--accent-gold);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--accent-gold);
  text-shadow: 0 0 5px rgba(230, 194, 41, 0.7);
}

.spin-button {
  background: linear-gradient(45deg, var(--accent-purple), #8e44ad);
  margin-top: 1rem;
}

.spin-button:hover {
  background: linear-gradient(45deg, #9b59b6, #8e44ad);
}

.ludopata-result {
  margin-top: 1rem;
  padding: 1rem;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 10px;
}

.ludopata-result-item {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
}

.ludopata-result-item:last-child {
  border-bottom: none;
}

.winner {
  font-weight: bold;
  color: var(--accent-gold);
  text-shadow: 0 0 5px rgba(230, 194, 41, 0.7);
}

/* ── HEADER DECORATION ────────────────────────────────────── */
.header-decoration {
  position: absolute;
  top: 0;
  right: 0;
  font-size: 3rem;
  opacity: 0.1;
  transform: rotate(20deg);
  z-index: -1;
}

/* ── LOADER ───────────────────────────────────────────────── */
.loader {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: var(--accent-gold);
  animation: spin 1s ease-in-out infinite;
  margin-right: 10px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

#version-info {
  position: fixed;
  bottom: 25px;
  right: 25px;
  color: var(--muted);
  font-size: 0.8rem;
  z-index: 1000;
  opacity: 0.7;
  pointer-events: none;
}

/* ── ESTADO DE PRESO ──────────────────────────────────────── */
.prison-counter {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 221, 87, 0.2);
  color: var(--role-neutral);
  border-radius: 12px;
  padding: 2px 8px;
  margin-left: 8px;
  font-size: 0.8rem;
  font-weight: bold;
}

/* ── MEDUSA EVENT STYLES ──────────────────────────────────── */
.medusa-event {
  background: rgba(155, 89, 182, 0.1);
  border: 1px solid var(--accent-purple);
  border-radius: 12px;
  padding: 1.5rem;
  margin: 1.5rem 0;
  position: relative;
  overflow: hidden;
}

.medusa-event::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent-purple), transparent);
}

.medusa-event h3 {
  color: var(--accent-purple);
  margin-top: 0;
  text-align: center;
  font-family: 'Cinzel Decorative', cursive;
}

.medusa-player {
  display: flex;
  align-items: center;
  padding: 0.8rem;
  margin: 0.5rem 0;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  transition: var(--transition);
}

.medusa-player:hover {
  background: rgba(0, 0, 0, 0.3);
}

.medusa-player.selected {
  background: rgba(155, 89, 182, 0.3);
  border: 1px solid var(--accent-purple);
}

@keyframes pulse {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(155, 89, 182, 0.4); }
  50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(155, 89, 182, 0.8); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(155, 89, 182, 0.4); }
}

/* ── DECORACIONES DE FONDO ───────────────────────────────── */
.background-decoration {
  position: fixed;
  z-index: -1;
  opacity: 0.05;
  font-size: 5rem;
  animation: float 6s infinite ease-in-out;
}

.decoration-1 { top: 10%; left: 5%; animation-delay: 0s; }
.decoration-2 { top: 20%; right: 10%; animation-delay: 1s; }
.decoration-3 { bottom: 15%; left: 15%; animation-delay: 2s; }
.decoration-4 { bottom: 25%; right: 5%; animation-delay: 3s; }

/* ── ICONOS PARA ROLES ───────────────────────────────────── */
.role-icon {
  font-size: 1.5rem;
  width: 30px;
  text-align: center;
}

.role-icon-asesino { color: var(--accent-red); }
.role-icon-policia { color: var(--accent-blue); }
.role-icon-medico { color: var(--accent-green); }
.role-icon-bartender { color: var(--accent-gold); }
.role-icon-ladron { color: #aaa; }
.role-icon-loco { color: var(--role-neutral); }
.role-icon-puta { color: #ff69b4; }
.role-icon-dealer { color: #7b68ee; }
.role-icon-hidratador { color: #00bfff; }
.role-icon-envidioso { color: #32cd32; }
.role-icon-menor { color: #add8e6; }
.role-icon-Chulo { color: #ff4500; }
.role-icon-ludopata { color: #9370db; }
.role-icon-suicida { color: #ff6347; }
.role-icon-investigador { color: #20b2aa; }

/* ── MEDIA QUERIES ────────────────────────────────────────── */
@media (max-width: 500px) {
  #app {
    padding: 0.5rem;
  }
  
  .card {
    padding: 1.2rem;
  }
  
  h1 {
    font-size: 2.2rem;
  }
  
  h2 {
    font-size: 1.5rem;
  }
  
  .vote-count div {
    min-width: 80px;
    padding: 0.6rem;
  }
  
  .prison-counter {
    margin-left: 4px;
    padding: 1px 5px;
    font-size: 0.7rem;
  }
}
/* Nuevos estilos para selección de roles */
.role-selection-container {
  display: flex;
  flex-direction: column;
  gap: 20px;
  margin: 1.5rem 0;
}

.role-selection-card {
  background: var(--card-bg);
  border: 2px solid rgba(230, 194, 41, 0.3);
  border-radius: 16px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 15px;
}

.role-selection-card:hover {
  transform: translateY(-5px);
  border-color: var(--accent-gold);
  box-shadow: 0 10px 25px rgba(230, 194, 41, 0.2);
}

.role-selection-card.selected {
  border-color: var(--accent-gold);
  background: rgba(230, 194, 41, 0.1);
  box-shadow: 0 0 15px rgba(230, 194, 41, 0.3);
}

.role-selection-icon {
  font-size: 2rem;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.2);
}

.role-selection-content {
  flex: 1;
}

.role-selection-content h3 {
  margin-top: 0;
  margin-bottom: 8px;
  color: var(--accent-gold);
}

.role-selection-content p {
  margin: 0;
  font-size: 0.95rem;
  color: var(--muted);
}

.role-assignment-container {
  margin-top: 20px;
  background: rgba(30, 30, 45, 0.7);
  border-radius: 16px;
  padding: 10px;
  border: 1px solid rgba(230, 194, 41, 0.2);
  display: none;
}

.role-assignment-container.visible {
  display: block;
  animation: fadeIn 0.5s ease;
}

.role-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.role-item-card {
  background: rgba(40, 40, 60, 0.6);
  border-radius: 12px;
  padding: 15px;
  transition: all 0.3s ease;
  border-left: 3px solid var(--accent-gold);
  display: flex;
  align-items: center;
  gap: 35px;
}

.role-item-card:hover {
  transform: translateY(-3px);
  background: rgba(50, 50, 70, 0.7);
}

.role-item-icon {
  font-size: 1.5rem;
  min-width: 40px;
  text-align: center;
}

.role-item-name {
  flex: 1;
  font-weight: 500;
}

.role-counter {
  text-align: center;
  margin: 15px 0;
  font-size: 1.1rem;
  font-weight: 600;
  padding: 10px;
  border-radius: 10px;
  background: rgba(30, 30, 45, 0.8);
}

.role-counter.total-ok {
  color: var(--role-good);
  border: 2px solid var(--role-good);
}

.role-counter.total-warning {
  color: var(--role-neutral);
  border: 2px solid var(--role-neutral);
}

.role-counter.total-error {
  color: var(--role-bad);
  border: 2px solid var(--role-bad);
}

.role-input {
  width: 40px;
  padding: 3px;
  background: rgba(20, 20, 30, 0.7);
  color: var(--text);
  border: 1px solid var(--accent-gold);
  border-radius: 8px;
  text-align: center;
  font-size: 0.8rem;
}

.role-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 2px rgba(50, 152, 220, 0.3);
}

/* Animación para la sección de asignación */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ── ESTILOS PARA EL DIFÍCIL ─────────────────────────────── */
.difficulty-select {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin: 1.5rem 0;
}

.difficulty-btn {
  background: rgba(30, 30, 50, 0.6) !important;
  border: 1px solid var(--accent-gold);
  display: flex;
  justify-content: center;
  align-items: center;
}

.difficulty-btn:hover {
  transform: scale(1.03);
  box-shadow: 0 0 15px rgba(230, 194, 41, 0.4);
}

.difficulty-btn[data-level="pussy"] {
  background: linear-gradient(45deg, rgba(50, 152, 220, 0.7), rgba(50, 152, 220, 0.9)) !important;
}

.difficulty-btn[data-level="girls"] {
  background: linear-gradient(45deg, rgba(155, 89, 182, 0.7), rgba(155, 89, 182, 0.9)) !important;
}

.difficulty-btn[data-level="alcoholico"] {
  background: linear-gradient(45deg, rgba(255, 56, 96, 0.7), rgba(255, 56, 96, 0.9)) !important;
}

.role-icon-ciudadano { color: #aaa; }

/* NUEVOS ESTILOS PARA TARJETAS DE DIFICULTAD */
.difficulty-cards-container {
  display: flex;
  flex-direction: column;
  gap: 40px;
  margin: 2rem 0;
}

.difficulty-card {
  position: relative;
  background: var(--card-bg);
  border-radius: 20px;
  padding: 90px 20px 20px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.4s ease;
  border: 2px solid;
  box-shadow: var(--box-shadow);
  overflow: visible;
  min-height: 250px;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
}

.difficulty-card:hover {
  transform: translateY(-10px);
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.8);
}

.difficulty-card-image {
  position: absolute;
  top: -10px;
  left: 50%;
  transform: translateX(-50%);
  width: 140px;
  height: 140px;
  z-index: 1;
}

.difficulty-card-image img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.5));
  transition: all 0.4s ease;
}

.difficulty-card:hover .difficulty-card-image img {
  transform: scale(1.1);
  filter: drop-shadow(0 15px 20px rgba(0, 0, 0, 0.7));
}

.difficulty-card h3 {
  font-size: 1.4rem;
  margin: 30px 0;
  background: linear-gradient(45deg, #ffd700, #e6c229);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-family: 'Cinzel Decorative', cursive;
  z-index: 10;
}

.difficulty-card p {
  font-size: 1rem;
  color: var(--muted);
  margin-bottom: 15px;
}

.difficulty-card .difficulty-description {
  font-size: 0.9rem;
  color: var(--text);
  margin-top: 10px;
}

.difficulty-card.pussy { 
  border-color: var(--accent-blue);
  background: linear-gradient(to bottom, rgba(18, 18, 30, 0.9), rgba(50, 152, 220, 0.15));
}

.difficulty-card.girls { 
  border-color: var(--accent-purple);
  background: linear-gradient(to bottom, rgba(18, 18, 30, 0.9), rgba(155, 89, 182, 0.15));
}

.difficulty-card.alcoholico { 
  border-color: var(--accent-red);
  background: linear-gradient(to bottom, rgba(18, 18, 30, 0.9), rgba(255, 56, 96, 0.15));
}

.difficulty-card::before {
  content: '';
  position: absolute;
  top: -20px;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--border-gradient);
}

.difficulty-card .difficulty-icon {
  font-size: 1.5rem;
  margin-right: 8px;
}

/* Animación para las imágenes */
@keyframes floatDifficulty {
  0% { transform: translate(-50%, 0); }
  50% { transform: translate(-50%, -10px); }
  100% { transform: translate(-50%, 0); }
}

.difficulty-card-image {
  animation: floatDifficulty 3s ease-in-out infinite;
}

.difficulty-card.pussy .difficulty-card-image {
  animation-delay: 0s;
}

.difficulty-card.girls .difficulty-card-image {
  animation-delay: 0.5s;
}

.difficulty-card.alcoholico .difficulty-card-image {
  animation-delay: 1s;
}

/* Nuevos estilos para imágenes de roles */
.role-image {
  width: 100px;
  height: 100px;
  object-fit: contain;
  margin: 0 auto 15px;
  display: block;
  border-radius: 50%;
  border: 2px solid var(--accent-gold);
  background: rgba(0, 0, 0, 0.3);
}

.player-role-icon {
  width: 24px;
  height: 24px;
  margin-right: 8px;
  vertical-align: middle;
  border-radius: 50%;
  border: 1px solid rgba(230, 194, 41, 0.5);
}

.floating-menu-container {
  position: fixed;
  left: 10px;
  bottom: 10px;
  z-index: 1000;
  -webkit-tap-highlight-color: transparent;
}

.menu-button {
  display: flex;
  align-items: center;
  background: linear-gradient(45deg, #e6c229, #c5a400);
  color: #000;
  border-radius: 50px;
  padding: 0;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
  width: 50px;
  height: 50px;
  overflow: hidden;
  border: 2px solid rgba(0, 0, 0, 0.2);
}

.menu-button.expanded {
  width: 170px;
}

.menu-icon {
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  flex-shrink: 0;
}

.menu-text {
  opacity: 0;
  width: 0;
  white-space: nowrap;
  overflow: hidden;
  transition: opacity 0.3s ease;
  font-weight: 600;
  padding-right: 15px;
  font-size: 0.9rem;
}

.menu-button.expanded .menu-text {
  opacity: 1;
  width: auto;
}

/* Modal de confirmación */
.confirmation-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 10, 18, 0.8);
  backdrop-filter: blur(5px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.confirmation-modal.active {
  opacity: 1;
  pointer-events: all;
}

.modal-content {
  background: var(--card-bg);
  border-radius: 20px;
  padding: 2rem;
  text-align: center;
  max-width: 350px;
  width: 90%;
  box-shadow: var(--box-shadow);
  border: 2px solid var(--accent-gold);
  transform: translateY(20px);
  transition: transform 0.3s ease;
}

.confirmation-modal.active .modal-content {
  transform: translateY(0);
}

.modal-content h3 {
  color: var(--accent-gold);
  margin-bottom: 1.5rem;
  font-family: 'Cinzel Decorative', cursive;
}

.modal-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 1.5rem;
}

.modal-btn {
  padding: 10px 20px;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  min-width: 100px;
}

.modal-btn.confirm {
  background: linear-gradient(45deg, #ff3860, #d7002b);
  color: white;
}

.modal-btn.cancel {
  background: linear-gradient(45deg, #3298dc, #238cd3);
  color: white;
}

.modal-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}

.modal-btn:active {
  transform: translateY(1px);
}


</style>
</head>
<body>
<!-- Decoraciones de fondo -->
<div class="background-decoration decoration-1">🍷</div>
<div class="background-decoration decoration-2">🔪</div>
<div class="background-decoration decoration-3">🕵️</div>
<div class="background-decoration decoration-4">👮</div>

<div id="app"></div>
<div id="version-info">v.1.0</div>
<audio id="spinSound" src="sounds/slot.mp3" preload="auto"></audio>
<audio id="medusaSound" src="sounds/medusa.mp3" preload="auto"></audio>
<audio id="notSound" src="sounds/not.mp3" preload="auto"></audio>
<audio id="asesinoSound" src="sounds/asesino.mp3" preload="auto"></audio>

<div class="floating-menu-container">
  <div class="menu-button" id="menuButton">
    <div class="menu-icon">
      <i class="fas fa-home"></i>
    </div>
    <div class="menu-text" id="menuText">
      <span>Menú Principal</span>
    </div>
  </div>
</div>

<div class="confirmation-modal" id="confirmationModal">
  <div class="modal-content">
    <h3><i class="fas fa-exclamation-triangle"></i> Confirmar acción</h3>
    <p>¿Estás seguro de que quieres volver al menú principal? Se perderá el progreso actual.</p>
    <div class="modal-buttons">
      <button class="modal-btn cancel" id="modalCancel">Cancelar</button>
      <button class="modal-btn confirm" id="modalConfirm">Aceptar</button>
    </div>
  </div>
</div>

<script>

  if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(err => console.error(err));
}

/* ==============================================================
   Noche de Es Tragos – Versión Élite (Actualizada)
   ============================================================== */
let gameStarted = false;
const app = document.getElementById('app');

// Variables para reinicio
let savedPlayers = [];
let savedSelectedRoles = null;

/* -------------------- ESTADO GLOBAL MEJORADO -------------------- */
const game = {
  numPlayers: 0,
  players: [],
  round: 0,
  phase: '',               // "night" / "day"
  eventLog: [],
  nightActions: null,     // {kills, protects, swaps, bartender, arrests}
  dayArrests: [],
  dayVotes: [],
  selectedRoles: null,    // Objeto con conteo de roles
  drinkEvents: [],
  assassinVotes: {},       // Almacena los votos de los asesinos
  nightSummaryData: null,   // Para almacenar acciones detalladas
  pendingLudopata: null,     // Almacena el Ludópata muerto pendiente de activar
  difficulty: 'girls'      // Niveles: 'pussy', 'girls', 'alcoholico'
};

// Configuración de tragos por nivel
const DRINK_CONFIG = {
  pussy: {
    murder: 1,
    arrest: 1,
    elimination: 1,
    bartender: 1,
    tie: 0,
    losingTeam: 1
  },
  girls: {
    murder: 2,
    arrest: 1,
    elimination: 2,
    bartender: 1,
    tie: 1,
    losingTeam: 2
  },
  alcoholico: {
    murder: 3,
    arrest: 1,
    elimination: 3,
    bartender: 2,
    tie: 2,
    losingTeam: 2
  }
};

/* ===== FUNCIONES DE SONIDO ===== */
function playSound(id) {
  const sound = document.getElementById(id);
  if (sound) {
    sound.currentTime = 0;
    sound.play().catch(e => console.log("Error al reproducir sonido:", e));
  }
}

function addDrinkEvent(msg) {
  game.drinkEvents.push(msg);
  playSound('notSound');
}

/* -------------------- UTILIDADES -------------------- */
function getPublicRole(role) {
  return role === "El menor" ? "El menor" : role;
}

function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
}

function log(msg) {
  const t = new Date().toLocaleTimeString();
  game.eventLog.push(`<span class="log-time">[${t}]</span> ${msg}`);
}

function getPlayer(id) { 
  return game.players.find(p => p.id === id); 
}

function renderLog() {
  const el = document.getElementById('eventLog');
  if (!el) return;
  el.innerHTML = game.eventLog.map(e => `<div class="event-entry">${e}</div>`).join('');
  el.scrollTop = el.scrollHeight;
}

function renderPlayerList() {
  const cont = document.getElementById('playerList');
  if (!cont) return;
  
  // Verificar si la partida ha comenzado (jugadores tienen roles asignados)
  const gameStarted = game.players.length > 0 && game.players[0].role !== null;
  
  // Solo mostrar encabezado si la partida ha comenzado
  const header = gameStarted ? `
    <div class="player-item header">
      <span class="player-name">Nombre</span>
      <span class="player-drinks">Tragos</span>
      <span class="player-status">Estado</span>
    </div>
  ` : '';
  
  cont.innerHTML = `
    <h4 class="neon"></h4>
    ${header}
    ${game.players.map(p => {
      const roleImage = 'ciudadano.png';
      return `
      <div class="player-item">
        <span class="player-name">
          <img src="img/${roleImage}" alt="${p.role}" class="player-role-icon">
          ${p.name} 
          ${p.status === 'eliminado' ? `<span class="role-badge">${getPublicRole(p.role)}</span>` : ''}
          ${p.drugged && game.phase === 'day' ? `<span class="role-badge" style="background: rgba(155, 89, 182, 0.2); color: var(--accent-purple);">Drogado</span>` : ''}
          ${p.status === 'preso' ? `
            <span class="role-badge" style="background: rgba(255, 221, 87, 0.2); color: var(--role-neutral);">
              Preso
              <span class="prison-counter">${p.detainedRounds} rondas</span>
            </span>
          ` : ''}
          ${(p.hydrated && game.phase === 'day') ? `<span class="role-badge hidratado">Hidratado</span>` : ''}
        </span>
        <span class="player-drinks">${p.drinks || 0} <span class="drink-icon">🍸</span></span>
        <span class="player-status status-${p.status}">
          <i class="fas ${p.status === 'vivo' ? 'fa-heart' : p.status === 'preso' ? 'fa-lock' : 'fa-skull'}"></i>
          ${p.status}
        </span>
      </div>`
    }).join('')}`;
}
/* -------------------- RENDERIZADO GENÉRICO -------------------- */
function setScreen(content) {
  app.innerHTML = `
    <div id="playerList"></div>
    ${content}
    <div class="header-decoration">⚔️</div>
  `;
  renderPlayerList();
}

/* -------------------- CONFIRMACIÓN DE TURNO -------------------- */
function showConfirmPlayer(player, nextFn) {
  const html = `
    <div class="card confirm-card">
      <h2>¿Eres ${player.name}?</h2>
      <p>Presiona "Continuar" para acceder a tus opciones.</p>
      <button id="btnConfirmPlayer"><i class="fas fa-arrow-right"></i> Continuar</button>
    </div>`;
  setScreen(html);
  document.getElementById('btnConfirmPlayer').onclick = nextFn;
}

/* ===== MAPA DE IMÁGENES POR ROL ===== */
const ROLE_IMAGES = {
  "Asesino": "asesino.png",
  "Policía": "policia.png",
  "Loco": "loco.png",
  "Médico": "medico.png",
  "Bartender": "bartender.png",
  "Ladrón": "ladron.png",
  "Investigador": "investigador.png",
  "Suicida": "suicida.png",
  "Puta": "puta.png",
  "Dealer": "dealer.png",
  "Hidratador": "hidratador.png",
  "Envidioso": "envidioso.png",
  "El menor": "menor.png",
  "Chulo": "Chulo.png",
  "Ludópata": "ludopata.png",
  "Ciudadano": "ciudadano.png"
};

/* -------------------- DESCRIPCIONES DE ROLES ACTUALIZADAS -------------------- */
const ROLE_DESCRIPTIONS = {
  "Asesino": "Vota con otros asesinos para matar a un jugador cada noche. Conoces a tus compañeros asesinos. <span class='role-bad'>(Maligno)</span>",
  "Policía": "Puede arrestar a un jugador durante la noche. No conoces a otros policías. <span class='role-good'>(Bueno)</span>",
  "Loco": "Arresta aleatoriamente y vota al azar. <span class='role-good'>(Bueno)</span>",
  "Médico": "Puede proteger a un jugador cada noche. <span class='role-good'>(Bueno)</span>",
  "Bartender": "Elige a quien tomará un trago al amanecer. <span class='role-good'>(Bueno)</span>",
  "Ladrón": "Puedes robar el rol de otro jugador una vez durante el juego. Pero cuidado: ¡si intentas robar a un Policía o Investigador, irás preso y perderás tu habilidad! <span class='role-good'>(Bueno)</span>",
  "Investigador": "Revela el rol de alguien una vez y luego se vuelve Policía. <span class='role-good'>(Bueno)</span>",
  "Suicida": "Si es arrestado, se elimina inmediatamente. Si se enamora, muere con su amada. <span class='role-good'>(Bueno)</span>",
  "Puta": "Elige con quien acostarse; si es Asesino puede contagiar. <span class='role-good'>(Bueno)</span>",
  "Dealer": "Droga a un jugador multiplicando sus tragos por 2. <span class='role-good'>(Bueno)</span>",
  "Hidratador": "Elige quien no tomará su próximo shot de la ronda. Se resetea cada noche. <span class='role-good'>(Bueno)</span>",
  "Envidioso": "Elige un jugador al principio del juego. Al final, el que menos tragos haya tomado de los dos toma 2 shots. <span class='role-good'>(Bueno)</span>",
  "El menor": "Eres un ciudadano común, pero si eres arrestado te convertirás en asesino. <span class='role-good'>(Bueno)</span>",
  "Chulo": "Si la Puta se acuesta contigo, tú controlarás con quién se acuesta cada noche. <span class='role-good'>(Bueno)</span>",
  "Ludópata": "Al morir, activa una ruleta que elige 3 jugadores al azar que deben tomar 1 shot cada uno. <span class='role-good'>(Bueno)</span>"
};

/* -------------------- LISTA DE ROLES DISPONIBLES ACTUALIZADA -------------------- */
const ALL_ROLES = [
  "Asesino", "Policía", "Loco", "Médico", "Bartender",
  "Ladrón", "Investigador", "Suicida", "Puta", "Dealer",
  "Hidratador", "Envidioso", "El menor", "Chulo", "Ludópata", "Ciudadano"
];

/* -------------------- ICONOS PARA ROLES -------------------- */
const ROLE_ICONS = {
  "Asesino": "fa-user-ninja role-icon-asesino",
  "Policía": "fa-shield-alt role-icon-policia",
  "Loco": "fa-grin-tongue-wink role-icon-loco",
  "Médico": "fa-heartbeat role-icon-medico",
  "Bartender": "fa-cocktail role-icon-bartender",
  "Ladrón": "fa-mask role-icon-ladron",
  "Investigador": "fa-search role-icon-investigador",
  "Suicida": "fa-skull role-icon-suicida",
  "Puta": "fa-heart role-icon-puta",
  "Dealer": "fa-cannabis role-icon-dealer",
  "Hidratador": "fa-tint role-icon-hidratador",
  "Envidioso": "fa-eye role-icon-envidioso",
  "El menor": "fa-child role-icon-menor",
  "Chulo": "fa-money-bill-wave role-icon-Chulo",
  "Ludópata": "fa-dice role-icon-ludopata",
  "Ciudadano": "fa-user role-icon-ciudadano",
};

/* -------------------- PANTALLA DE INICIO MEJORADA -------------------- */
function showStartScreen() {
  const html = `
    <div class="card">
      <h1>Noche de EsTragos</h1>
      <p style="text-align:center; font-size:1.2rem; margin-bottom: 1.5rem;">Juego de roles con tragos. Elige el nivel de dificultad:</p>
      
      <div class="carousel-container">
        <div class="carousel">
          <div class="carousel-item pussy" data-level="pussy">
          <div class="bubbles">
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
          </div>
            <img src="img/pussy.png" alt="Pussy" class="carousel-image">
            <h3><i class="fas fa-cat"></i> Pussy</h3>
            <p class="carousel-description">Tragos reducidos. Ideal para principiantes.</p>
            
          </div>
          
          <div class="carousel-item girls" data-level="girls">
          <div class="bubbles">
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
          </div>
            <img src="img/girls.png" alt="Girls" class="carousel-image">
            <h3><i class="fas fa-female"></i> Girls</h3>
            <p class="carousel-description">Dificultad media. Tragos equilibrados para jugar y divertirse.</p>

          </div>
          
          <div class="carousel-item alcoholico" data-level="alcoholico">
          <div class="bubbles">
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
          </div>
            <img src="img/alcoholico.png" alt="Alcohólico" class="carousel-image">
            <h3><i class="fas fa-beer"></i> Alcohólico</h3>
            <p class="carousel-description">Tragos intensificados con eventos especiales.</p>
            
          </div>
        </div>
        
        <div class="carousel-controls">
          <button class="carousel-btn prev"><i class="fas fa-chevron-left"></i></button>
          <button class="carousel-btn next"><i class="fas fa-chevron-right"></i></button>
        </div>
        
        <div class="carousel-indicators">
          <div class="carousel-indicator active" data-index="0"></div>
          <div class="carousel-indicator" data-index="1"></div>
          <div class="carousel-indicator" data-index="2"></div>
        </div>
      </div>
      
      <button id="btnStart"><i class="fas fa-play"></i> Iniciar partida</button>
      <button id="btnInfo" class="secondary"><i class="fas fa-book"></i> Instrucciones</button>
    </div>`;
  
  setScreen(html);
  
  // Inicializar el carrusel
  initCarousel();
  
  document.getElementById('btnInfo').onclick = showInstructions;
  document.getElementById('btnStart').onclick = () => startSetup();
}

/* ===== FUNCIONALIDAD DEL CARRUSEL ===== */
function initCarousel() {
  const carousel = document.querySelector('.carousel');
  const items = document.querySelectorAll('.carousel-item');
  const indicators = document.querySelectorAll('.carousel-indicator');
  const prevBtn = document.querySelector('.carousel-btn.prev');
  const nextBtn = document.querySelector('.carousel-btn.next');
  
  let currentIndex = 0;
  
  // Actualizar el carrusel
  function updateCarousel() {
    carousel.style.transform = `translateX(-${currentIndex * 100}%)`;
    
    // Actualizar indicadores
    indicators.forEach((indicator, index) => {
      indicator.classList.toggle('active', index === currentIndex);
    });
    
    // Actualizar dificultad seleccionada
    game.difficulty = items[currentIndex].dataset.level;
  }
  
  // Event listeners para los controles del carrusel
  prevBtn.addEventListener('click', () => {
    currentIndex = (currentIndex - 1 + items.length) % items.length;
    updateCarousel();
  });
  
  nextBtn.addEventListener('click', () => {
    currentIndex = (currentIndex + 1) % items.length;
    updateCarousel();
  });
  
  // Event listeners para los indicadores
  indicators.forEach(indicator => {
    indicator.addEventListener('click', () => {
      currentIndex = parseInt(indicator.dataset.index);
      updateCarousel();
    });
  });
  
  // Event listeners para gestos táctiles
  let touchStartX = 0;
  let touchEndX = 0;
  
  carousel.addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
  }, false);
  
  carousel.addEventListener('touchend', e => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  }, false);
  
  function handleSwipe() {
    const swipeThreshold = 50;
    
    if (touchEndX < touchStartX - swipeThreshold) {
      // Deslizar a la izquierda
      currentIndex = (currentIndex + 1) % items.length;
      updateCarousel();
    }
    
    if (touchEndX > touchStartX + swipeThreshold) {
      // Deslizar a la derecha
      currentIndex = (currentIndex - 1 + items.length) % items.length;
      updateCarousel();
    }
  }
  
  // Inicializar el carrusel
  updateCarousel();
}

/* -------------------- INSTRUCCIONES MEJORADAS -------------------- */
function showInstructions() {
  const html = `
    <div class="instructions-container">
      <div class="instructions-section">
        <h2><i class="fas fa-book"></i> Instrucciones del Juego</h2>
        <div class="instructions-content">
          <p>Noche de EsTragos es un juego de roles donde los jugadores asumen diferentes personajes con habilidades únicas. El juego se divide en fases de <strong>Noche</strong> y <strong>Día</strong>, donde cada rol tiene acciones específicas que realizar.</p>
          
          <div class="instruction-steps">
            <div class="instruction-step">
              <h3><i class="fas fa-users"></i> Preparación</h3>
              <p>1. Selecciona la dificultad (Pussy, Girls o Alcohólico)</p>
              <p>2. Elige el número de jugadores (4-20)</p>
              <p>3. Asigna roles manualmente o de forma aleatoria</p>
              <p>4. Cada jugador verá su rol en privado</p>
            </div>
            
            <div class="instruction-step">
              <h3><i class="fas fa-play-circle"></i> Cómo Jugar</h3>
              <p>• El teléfono se pasa entre jugadores en cada fase</p>
              <p>• En la noche, los roles especiales realizan sus acciones</p>
              <p>• En el día, todos votan para eliminar a un jugador</p>
              <p>• Los eventos del juego conllevan tomar tragos</p>
            </div>
          </div>
          
          <div class="phase-diagram">
            <div class="phase-card night">
              <div class="phase-icon"><i class="fas fa-moon"></i></div>
              <div class="phase-title">Fase Nocturna</div>
              <ul class="phase-steps">
                <li>Asesinos votan para matar</li>
                <li>Policías planean arrestos</li>
                <li>Médicos protegen jugadores</li>
                <li>Otros roles realizan sus acciones</li>
              </ul>
            </div>
            
            <div class="phase-card day">
              <div class="phase-icon"><i class="fas fa-sun"></i></div>
              <div class="phase-title">Fase Diurna</div>
              <ul class="phase-steps">
                <li>Se aplican arrestos nocturnos</li>
                <li>Jugadores arrestados beben</li>
                <li>Discusión y votación pública</li>
                <li>Jugador eliminado revela su rol y bebe</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <div class="instructions-section">
        <h2><i class="fas fa-glass-martini-alt"></i> Tragos y Dificultad</h2>
        <p>En este juego, cada evento conlleva tomar tragos según la dificultad seleccionada:</p>
        
        <div class="difficulty-cards">
          <div class="difficulty-card pussy">
            <h3><i class="fas fa-cat"></i> Pussy</h3>
            <p>Tragos reducidos. Ideal para principiantes.</p>
            <div class="drink-rules">
              <div class="drink-rule">
                <div class="drink-rule-icon"><i class="fas fa-skull"></i></div>
                <div class="drink-rule-text">Asesinato: <strong>1 trago</strong></div>
              </div>
              <div class="drink-rule">
                <div class="drink-rule-icon"><i class="fas fa-ban"></i></div>
                <div class="drink-rule-text">Eliminación: <strong>1 trago</strong></div>
              </div>
              <div class="drink-rule">
                <div class="drink-rule-icon"><i class="fas fa-glass-martini-alt"></i></div>
                <div class="drink-rule-text">Bartender: <strong>1 trago</strong></div>
              </div>
            </div>
          </div>
          
          <div class="difficulty-card girls">
            <h3><i class="fas fa-female"></i> Girls</h3>
            <p>Dificultad media. Tragos equilibrados ideal para jugar y divertirse.</p>
            <div class="drink-rules">
              <div class="drink-rule">
                <div class="drink-rule-icon"><i class="fas fa-skull"></i></div>
                <div class="drink-rule-text">Asesinato: <strong>2 tragos</strong></div>
              </div>
              <div class="drink-rule">
                <div class="drink-rule-icon"><i class="fas fa-ban"></i></div>
                <div class="drink-rule-text">Eliminación: <strong>2 tragos</strong></div>
              </div>
              <div class="drink-rule">
                <div class="drink-rule-icon"><i class="fas fa-glass-martini-alt"></i></div>
                <div class="drink-rule-text">Bartender: <strong>1 trago</strong></div>
              </div>
            </div>
          </div>
          
          <div class="difficulty-card alcoholico">
            <h3><i class="fas fa-beer"></i> Alcohólico</h3>
            <p>Para expertos. Tragos intensificados con eventos especiales.</p>
            <div class="drink-rules">
              <div class="drink-rule">
                <div class="drink-rule-icon"><i class="fas fa-skull"></i></div>
                <div class="drink-rule-text">Asesinato: <strong>3 tragos</strong></div>
              </div>
              <div class="drink-rule">
                <div class="drink-rule-icon"><i class="fas fa-ban"></i></div>
                <div class="drink-rule-text">Eliminación: <strong>3 tragos</strong></div>
              </div>
              <div class="drink-rule">
                <div class="drink-rule-icon"><i class="fas fa-glass-martini-alt"></i></div>
                <div class="drink-rule-text">Bartender: <strong>2 tragos</strong></div>
              </div>
              <div class="drink-rule">
                <div class="drink-rule-icon"><i class="fas fa-eye"></i></div>
                <div class="drink-rule-text">Evento especial: <strong>La Medusa</strong></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="instructions-content" style="margin-top: 20px;">
          <p><strong>Notas importantes:</strong></p>
          <ul>
            <li>Los jugadores <strong>drogados</strong> toman el doble de tragos</li>
            <li>Los jugadores <strong>hidratados</strong> no toman su próximo trago</li>
            <li>Los jugadores <strong>presos</strong> no pueden votar pero pueden ser votados</li>
          </ul>
        </div>
      </div>
      
      <div class="instructions-section">
        <h2><i class="fas fa-mask"></i> Roles Disponibles</h2>
        <p>Cada jugador tiene un rol con habilidades únicas:</p>
        
        <div class="role-grid">
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-shield-alt"></i></div>
              <div>
                <div class="role-title">Policía <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Puede arrestar a un jugador durante la noche. No conoces a otros policías.</p>
            </div>
          </div>
          
          <div class="role-card role-bad">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-user-ninja"></i></div>
              <div>
                <div class="role-title">Asesino <span class="role-alignment">Maligno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Vota con otros asesinos para matar a un jugador cada noche. Conoces a tus compañeros asesinos.</p>
            </div>
          </div>
          
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-heartbeat"></i></div>
              <div>
                <div class="role-title">Médico <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Protege a un jugador cada noche, evitando que sea asesinado.</p>
            </div>
          </div>
          
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-cocktail"></i></div>
              <div>
                <div class="role-title">Bartender <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Elige a un jugador que tomará un trago adicional al amanecer.</p>
            </div>
          </div>
          
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-grin-tongue-wink"></i></div>
              <div>
                <div class="role-title">Loco <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Arresta jugadores y vota al azar. Actúa automáticamente sin intervención.</p>
            </div>
          </div>
          
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-mask"></i></div>
              <div>
                <div class="role-title">Ladrón <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Puedes robar el rol de otro jugador una vez durante el juego.</p>
            </div>
          </div>
          
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-search"></i></div>
              <div>
                <div class="role-title">Investigador <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Revela el rol de otro jugador una vez, luego te conviertes en Policía.</p>
            </div>
          </div>
          
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-skull"></i></div>
              <div>
                <div class="role-title">Suicida <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Si eres arrestado, te eliminas inmediatamente. Si te enamoras, mueres con tu amada.</p>
            </div>
          </div>
          
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-heart"></i></div>
              <div>
                <div class="role-title">Puta <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Elige con quién acostarte cada noche. Si es un Asesino, te infecta con VIH.</p>
            </div>
          </div>
          
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-cannabis"></i></div>
              <div>
                <div class="role-title">Dealer <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Droga a un jugador, haciendo que tome el doble de tragos.</p>
            </div>
          </div>
          
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-tint"></i></div>
              <div>
                <div class="role-title">Hidratador <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Protege a un jugador para que no tome su próximo trago. Se resetea cada noche.</p>
            </div>
          </div>
          
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-eye"></i></div>
              <div>
                <div class="role-title">Envidioso <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Al final del juego, el que menos tragos haya tomado entre tú y tu objetivo toma 2 shots.</p>
            </div>
          </div>
          
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-child"></i></div>
              <div>
                <div class="role-title">El Menor <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Ciudadano común. Si eres arrestado, te conviertes en Asesino después de cumplir tu condena.</p>
            </div>
          </div>
          
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-money-bill-wave"></i></div>
              <div>
                <div class="role-title">Chulo <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Si la Puta se acuesta contigo, tú controlarás con quién se acuesta cada noche.</p>
            </div>
          </div>
          
          <div class="role-card role-good">
            <div class="role-header">
              <div class="role-icon"><i class="fas fa-dice"></i></div>
              <div>
                <div class="role-title">Ludópata <span class="role-alignment">Bueno</span></div>
              </div>
            </div>
            <div class="role-description">
              <p>Al morir, activas una ruleta que elige 3 jugadores al azar que deben tomar 1 shot cada uno.</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="back-button-container">
        <button id="btnBack" class="secondary"><i class="fas fa-arrow-left"></i> Volver al Inicio</button>
      </div>
    </div>
  `;
  
  app.innerHTML = html;
  document.getElementById('btnBack').onclick = showStartScreen;
}

/* -------------------- CONFIGURACIÓN INICIAL -------------------- */
function startSetup() {
  const html = `
    <div class="card">
      <h2><i class="fas fa-users"></i> ¿Cuántos jugadores?</h2>
      <input type="number" id="numPlayers" min="4" max="20" value="6" style="width:100%;">
      <button id="btnNext"><i class="fas fa-arrow-right"></i> Siguiente</button>
    </div>`;
  setScreen(html);
  document.getElementById('btnNext').onclick = () => {
    const n = parseInt(document.getElementById('numPlayers').value);
    if (isNaN(n) || n < 4 || n > 20) {
      alert('Introduce un número entre 4 y 20.');
      return;
    }
    game.numPlayers = n;
    showRoleSelection();
  };
}

/* -------------------- SELECCIÓN DE ROLES MEJORADA -------------------- */
function showRoleSelection() {
  const html = `
    <div class="card role-selection-screen">
      <h2 class="header-title">Selección de Roles</h2>
      <p>Elige cómo asignar los roles:</p>
      
      <div class="role-selection-container">
        <div class="role-selection-card" data-option="random">
          <div class="role-selection-icon">
            <i class="fas fa-random"></i>
          </div>
          <div class="role-selection-content">
            <h3>Asignación aleatoria</h3>
            <p>Los roles se distribuirán automáticamente de forma equilibrada.</p>
          </div>
        </div>
        
        <div class="role-selection-card" data-option="manual">
          <div class="role-selection-icon">
            <i class="fas fa-edit"></i>
          </div>
          <div class="role-selection-content">
            <h3>Selección manual</h3>
            <p>Elige tú mismo cuántos jugadores tendrán cada rol.</p>
          </div>
        </div>
      </div>
      
      <div class="role-assignment-container" id="manualSelection">
        <h3>Asignación Manual de Roles</h3>
        <p>Asigna la cantidad de cada rol (total: ${game.numPlayers}):</p>
        
        <div class="role-grid">
          ${ALL_ROLES.map(role => `
            <div class="role-item-card">
              <div class="role-item-icon">
                <i class="fas ${ROLE_ICONS[role]}"></i>
              </div>
              <div class="role-item-name">${role}</div>
              <input type="number" class="role-input" id="role_${role}" min="0" max="${game.numPlayers}" value="0">
            </div>
          `).join('')}
        </div>
        
        <div class="role-counter" id="roleCounter">Total seleccionado: 0/${game.numPlayers}</div>
      </div>
      
      <button id="btnRoleNext"><i class="fas fa-arrow-right"></i> Continuar</button>
    </div>
  `;
  
  setScreen(html);
  
  // Seleccionar la primera opción por defecto
  const randomCard = document.querySelector('[data-option="random"]');
  randomCard.classList.add('selected');
  
  // Manejar clic en las tarjetas
  document.querySelectorAll('.role-selection-card').forEach(card => {
    card.addEventListener('click', function() {
      // Quitar selección de todas las tarjetas
      document.querySelectorAll('.role-selection-card').forEach(c => 
        c.classList.remove('selected')
      );
      
      // Seleccionar esta tarjeta
      this.classList.add('selected');
      
      // Mostrar u ocultar la sección de asignación manual
      const manualSection = document.getElementById('manualSelection');
      if (this.dataset.option === 'manual') {
        manualSection.classList.add('visible');
        updateRoleCounter();
      } else {
        manualSection.classList.remove('visible');
      }
    });
  });
  
  // Actualizar contador de roles seleccionados
  const roleInputs = document.querySelectorAll('.role-input');
  roleInputs.forEach(input => {
    input.addEventListener('change', updateRoleCounter);
    input.addEventListener('input', updateRoleCounter);
  });
  
  // Botón continuar
  document.getElementById('btnRoleNext').onclick = () => {
    const selectedOption = document.querySelector('.role-selection-card.selected').dataset.option;
    
    if (selectedOption === 'random') {
      collectNames(0, []);
    } else {
      const selectedRoles = {};
      let total = 0;
      roleInputs.forEach(input => {
        const role = input.id.replace('role_', '');
        const count = parseInt(input.value) || 0;
        if (count > 0) {
          selectedRoles[role] = count;
          total += count;
        }
      });
      
      if (total > game.numPlayers) {
        alert(`Has seleccionado ${total} roles, pero solo hay ${game.numPlayers} jugadores.`);
        return;
      }
      
      // Validar que haya al menos 1 asesino
      if (!selectedRoles["Asesino"] || selectedRoles["Asesino"] < 1) {
        alert("Debe haber al menos un asesino.");
        return;
      }
      
      game.selectedRoles = selectedRoles;
      collectNames(0, []);
    }
  };
}

function updateRoleCounter() {
  const manualSection = document.getElementById('manualSelection');
  if (!manualSection.classList.contains('visible')) return;
  
  let total = 0;
  document.querySelectorAll('.role-input').forEach(input => {
    total += parseInt(input.value) || 0;
  });
  
  const counter = document.getElementById('roleCounter');
  if (counter) {
    counter.textContent = `Total seleccionado: ${total}/${game.numPlayers}`;
    
    // Actualizar clase según el total
    counter.classList.remove('total-ok', 'total-warning', 'total-error');
    
    if (total === game.numPlayers) {
      counter.classList.add('total-ok');
    } else if (total > game.numPlayers) {
      counter.classList.add('total-error');
    } else {
      counter.classList.add('total-warning');
    }
  }
}


/* -------------------- RECOLECTAR NOMBRES -------------------- */
function collectNames(idx, names) {
  if (idx >= game.numPlayers) {
    savedPlayers = names.slice(); // Guardar para reinicio
    game.players = names.map((nm, i) => ({
      id: i,
      name: nm.trim() || `Jugador ${i + 1}`,
      role: null,
      originalRole: null,
      status: 'vivo',       // vivo / preso / eliminado
      detainedRounds: 0,    // Rondas restantes de detención
      lastPartnerId: null,
      thiefUsed: false,
      stolenRole: null,     // Rol robado (para Ladrón)
      investigatorUsed: false,
      infected: false,
      drugged: false,      // Estado drogado (para Dealer)
      dealerLastTarget: null, // Último objetivo del Dealer
      drinks: 0,            // Tragos acumulados
      hydrated: false,      // Hidratador
      envidiaTargetId: null,// Envidioso
      inLoveWith: null,     // Suicida enamorado
      willBecomeAssassin: false, // Para "El menor" después del arresto
      pimpControlled: false,      // Para Puta: si está controlada por Chulo
      pimpId: null,               // Para Chulo: ID de la Puta controlada
      medicoLastTarget: null,      // Para Médico: último objetivo protegido
      delayedInfection: false,     // Nueva propiedad: infección diferida
      infectedRound: null          // Nueva propiedad: ronda de infección
    }));
    assignRoles();
    return;
  }
  const html = `
    <div class="card">
      <h2><i class="fas fa-user"></i> Nombre del jugador ${idx + 1}</h2>
      <input type="text" id="playerName" placeholder="Nombre">
      <button id="btnNextName"><i class="fas fa-arrow-right"></i> Siguiente</button>
    </div>`;
  setScreen(html);
  document.getElementById('btnNextName').onclick = () => {
    const n = document.getElementById('playerName').value.trim();
    if (!n) { alert('Introduce un nombre.'); return; }
    names.push(n);
    collectNames(idx + 1, names);
  };
}

/* -------------------- ASIGNACIÓN DE ROLES -------------------- */
function assignRoles() {
  savedSelectedRoles = game.selectedRoles; // Guardar para reinicio
  let roles = [];
  
  if (game.selectedRoles) {
    // Construir lista de roles según las cantidades seleccionadas
    Object.entries(game.selectedRoles).forEach(([role, count]) => {
      for (let i = 0; i < count; i++) {
        roles.push(role);
      }
    });
    
    // Completar con "Sin rol" si faltan
    while (roles.length < game.numPlayers) {
      roles.push("Ciudadano");
    }
  } else {
    // Asignación aleatoria original
    const pool = ALL_ROLES;
    // Siempre al menos un Asesino y un Policía
    roles = ["Asesino", "Policía"];
    if (game.numPlayers >= 6) roles.push("Médico", "Bartender");
    while (roles.length < game.numPlayers) {
      roles.push(pool[Math.floor(Math.random() * pool.length)]);
    }
  }
  
  shuffle(roles);
  game.players.forEach((p, i) => { 
    p.role = roles[i]; 
    p.originalRole = roles[i]; 
  });
  
  // Inicializar votos de asesinos
  game.assassinVotes = {};
  
  revealRoles(0);
}
/* -------------------- ASIGNACIÓN DE ROLES (MODIFICADA) -------------------- */
function assignRoles() {
  savedSelectedRoles = game.selectedRoles;
  let roles = [];
  
  if (game.selectedRoles) {
    Object.entries(game.selectedRoles).forEach(([role, count]) => {
      for (let i = 0; i < count; i++) {
        roles.push(role);
      }
    });
    
    while (roles.length < game.numPlayers) {
      roles.push("Ciudadano");
    }
  } else {
    const pool = ALL_ROLES;
    roles = ["Asesino", "Policía"];
    if (game.numPlayers >= 6) roles.push("Médico", "Bartender");
    while (roles.length < game.numPlayers) {
      roles.push(pool[Math.floor(Math.random() * pool.length)]);
    }
  }
  
  shuffle(roles);
  game.players.forEach((p, i) => { 
    p.role = roles[i]; 
    p.originalRole = roles[i]; 
  });
  
  // Inicializar la primera noche
  game.round = 1;
  game.phase = 'night';
  game.nightActions = { kills: [], protects: [], swaps: [], bartender: null, arrests: [], dealer: null, hydrator: null };
  game.nightSummaryData = {
    kills: [],
    arrests: [],
    bartender: null,
    dealer: null,
    puta: null,
    swaps: [],
    hydrator: null
  };
  game.assassinVotes = {};
  
  revealRoles(0);
}

/* -------------------- REVELAR ROL CON ACCIÓN NOCTURNA INTEGRADA -------------------- */
function revealRoles(idx) {
  if (idx >= game.players.length) {
    // Todas las revelaciones y acciones completadas, mostrar resumen de la primera noche
    nightSummary();
    return;
  }
  
  const p = game.players[idx];
  const html = `
    <div class="card">
      <h2>Jugador ${idx + 1}</h2>
      <p>Pasar el teléfono a <strong>${p.name}</strong> y pulsar "Mostrar mi rol".</p>
      <button id="btnShow"><i class="fas fa-eye"></i> Mostrar mi rol</button>
    </div>`;
  setScreen(html);
  
  document.getElementById('btnShow').onclick = () => {
    const publicRole = getPublicRole(p.role);
    let desc = ROLE_DESCRIPTIONS[p.role] || 'Sin habilidades especiales.';
    const roleImage = ROLE_IMAGES[p.role] || 'ciudadano.png';
    
    if (p.role === 'Asesino') {
      const otherAssassins = game.players.filter(
        pl => pl.role === 'Asesino' && pl.id !== p.id
      );
      if (otherAssassins.length > 0) {
        const names = otherAssassins.map(a => a.name).join(', ');
        desc += `<br><br>Tus compañeros asesinos son: <strong>${names}</strong>`;
      } else {
        desc += "<br><br>Eres el único asesino.";
      }
    }
    
    let card = '';
    const roleImageHTML = `<img src="img/${roleImage}" alt="${publicRole}" class="role-image">`;
    
    if (p.role === 'Envidioso') {
      const targets = game.players.filter(pl => pl.id !== p.id);
      const options = targets.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      
      card = `
        <div class="card role-card">
          <h3>Tu rol es:</h3>
          ${roleImageHTML}
          <h2 class="neon">${publicRole}</h2>
          <p>${desc}</p>
          <p>Elige a quién envidiarás:</p>
          <select id="envidiaTarget">
            ${options}
          </select>
          <button id="btnGotIt"><i class="fas fa-check"></i> Seleccionar</button>
        </div>`;
    } 
    else {
      card = `
        <div class="card role-card">
          <h3>Tu rol es:</h3>
          ${roleImageHTML}
          <h2 class="neon">${publicRole}</h2>
          <p>${desc}</p>
          <button id="btnGotIt"><i class="fas fa-check"></i> Entendido</button>
        </div>`;
    }
    
    setScreen(card);
    
    const btnHandler = () => {
      if (p.role === 'Envidioso') {
        const targetId = parseInt(document.getElementById('envidiaTarget').value);
        p.envidiaTargetId = targetId;
        log(`El Envidioso ha elegido envidiar a alguien`);
      } 
      
      // Después de revelar el rol, proceder con la acción nocturna (si es la primera noche)
      if (game.round === 1) {
        showNightAction(p, () => {
          revealRoles(idx + 1);
        });
      } else {
        revealRoles(idx + 1);
      }
    };
    
    document.getElementById('btnGotIt').onclick = btnHandler;
  };
}

/* -------------------- MOSTRAR ACCIÓN NOCTURNA (NUEVA FUNCIÓN) -------------------- */
function showNightAction(player, callback) {
  // Roles que no tienen acción nocturna
  const noActionRoles = ['Ciudadano', 'Suicida', 'Envidioso', 'El menor', 'Ludópata'];
  if (noActionRoles.includes(player.role)) {
    callback();
    return;
  }

  // Para el Loco: acción automática
  if (player.role === 'Loco') {
    const aliveTargets = game.players.filter(pl => pl.status === 'vivo' && pl.id !== player.id);
    if (aliveTargets.length) {
      const randomTarget = aliveTargets[Math.floor(Math.random() * aliveTargets.length)];
      game.nightActions.arrests.push({ officerId: player.id, targetId: randomTarget.id });
      game.nightSummaryData.arrests.push({
        officer: player,
        target: getPlayer(randomTarget.id)
      });
    }
    callback();
    return;
  }

  // Para los demás roles, mostrar interfaz de selección de objetivo
  let aliveTargets = game.players.filter(pl => 
    pl.status === 'vivo' && 
    pl.id !== player.id
  );

  // Filtros especiales para diferentes roles
  if (player.role === 'Asesino') {
    aliveTargets = aliveTargets.filter(pl => pl.role !== 'Asesino');
  }
  if (player.role === 'Dealer') {
    aliveTargets = aliveTargets.filter(pl => pl.id !== player.dealerLastTarget);
  }
  if (player.role === 'Puta') {
    aliveTargets = aliveTargets.filter(pl => pl.id !== player.lastPartnerId);
  }

  const opts = aliveTargets.map(pl => `<option value="${pl.id}">${pl.name}</option>`).join('');
  let inner = `<p>Es tu turno en la primera noche, <strong>${player.name}</strong> <span class="role-badge">${getPublicRole(player.role)}</span>.</p>`;

  switch (player.role) {
    case 'Asesino':
      const aliveAssassins = game.players.filter(
        pl => pl.role === "Asesino" && pl.status === "vivo" && pl.id !== player.id
      );
      const numAssassins = aliveAssassins.length + 1;
      
      let assassinInfo = `<p>Tus compañeros asesinos vivos son: <strong>${aliveAssassins.map(a => a.name).join(', ')}</strong></p>`;
      let voteInfo = '';
      
      if (numAssassins > 1) {
        const voteCounts = {};
        Object.values(game.assassinVotes).forEach(targetId => {
          voteCounts[targetId] = (voteCounts[targetId] || 0) + 1;
        });
        
        voteInfo = `<div class="assassin-vote">
          <h3>Consejo de Asesinos</h3>
          <p>Hay ${numAssassins} asesinos en juego. Cada uno vota en su turno.</p>
          <div class="vote-count">`;
          
        for (const [targetId, count] of Object.entries(voteCounts)) {
          const target = getPlayer(parseInt(targetId));
          voteInfo += `
            <div class="${game.assassinVotes[player.id] == targetId ? 'selected' : ''}">
              <div class="vote-target">${target.name}</div>
              <div>Votos: ${count}</div>
            </div>`;
        }
        
        voteInfo += `</div></div>`;
      }
      
      inner += `${assassinInfo}${voteInfo}<p>Elige a quién quieres asesinar:</p>
            <select id="target">${opts}</select>`;
      break;
    case 'Policía':
      inner += `<p>Elige a quién arrestarás mañana (no conoces a otros policías):</p>
                <select id="target">${opts}</select>`;
      break;
    case 'Ladrón':
      if (player.thiefUsed) {
        if (player.stolenRole) {
          inner += `<p>Ya robaste un rol (${player.stolenRole}). Ahora tienes ese rol.</p>`;
        } else {
          inner += `<p>Ya usaste tu robo. No puedes hacer nada.</p>`;
        }
      } else {
        inner += `<p>Puedes robar un rol ahora o esperar:</p>
                  <select id="target">
                    <option value="-1">No robar ahora</option>
                    ${opts}
                  </select>`;
      }
      break;
    case 'Investigador':
      if (player.investigatorUsed) {
        inner += `<p>Ya investigaste a alguien. No puedes hacer nada.</p>`;
      } else {
        inner += `<p>Elige a quién revelarás su rol (una sola vez). Luego serás Policía.</p>
                  <select id="target">${opts}</select>`;
      }
      break;
    case 'Médico':
      let medicTargets = game.players.filter(pl => 
        pl.status === 'vivo' && 
        (player.medicoLastTarget === null || pl.id !== player.medicoLastTarget)
      );
      
      if (medicTargets.length === 0) {
        inner += `<p>No hay objetivos válidos disponibles para proteger.</p>`;
      } else {
        const opts = medicTargets.map(pl => 
          `<option value="${pl.id}" ${pl.id === player.id ? 'selected' : ''}>${pl.name}${pl.id === player.id ? ' (tú mismo)' : ''}</option>`
        ).join('');
        
        inner += `<p>Elige a quién protegerás esta noche:</p>
                  <select id="target">${opts}</select>`;
      }
      break;
    case 'Puta':
      if (player.status === 'preso') {
        const otherPrisoners = game.players.filter(
          pl => pl.status === 'preso' && pl.id !== player.id
        );
        
        if (otherPrisoners.length > 0) {
          const randomPartner = otherPrisoners[Math.floor(Math.random() * otherPrisoners.length)];
          player.lastPartnerId = randomPartner.id;
          const partner = getPlayer(randomPartner.id);
          
          const isAsesino = partner.role === "Asesino";
          const isChulo = partner.role === "Chulo";
          
          if (isAsesino) {
            player.infected = true;
            partner.delayedInfection = true;
            partner.infectedRound = game.round;
            log(`${player.name} se acostó con ${partner.name} (Asesino) → ${player.name} muere por VIH. El Asesino se infecta pero podrá actuar una noche más.`);
          }
          
          if (isChulo) {
            player.pimpControlled = true;
            partner.pimpId = player.id;
            log(`${player.name} se acostó con el Chulo. ¡Ahora el Chulo controla sus acciones!`);
          }
          
          game.nightSummaryData.puta = {
            puta: player,
            target: partner,
            isAsesino: isAsesino,
            isChulo: isChulo
          };
          
          log(`${player.name} (presa) se acostó automáticamente con ${partner.name} (preso)`);
        } else {
          log(`${player.name} (presa) no encontró compañeros en prisión`);
        }
        callback();
        return;
      }

      if (player.pimpControlled) {
        callback();
        return;
      }
      
      const possible = aliveTargets.filter(pl => pl.id !== player.lastPartnerId);
      if (possible.length === 0) {
        inner += `<p>No hay candidatos válidos para acostarse.</p>`;
      } else {
        const optP = possible.map(pl => `<option value="${pl.id}">${pl.name}</option>`).join('');
        inner += `<p>Elige con quién acostarte (no puedes repetir 2 noches seguidas):</p>
                  <select id="target">${optP}</select>`;
      }
      break;
    case 'Chulo':
      if (player.pimpId !== null) {
        const putaPlayer = getPlayer(player.pimpId);
        if (putaPlayer && putaPlayer.status === 'vivo') {
          const possible = aliveTargets.filter(pl => 
            pl.id !== putaPlayer.lastPartnerId && 
            pl.id !== player.id
          );
          
          if (possible.length === 0) {
            inner += `<p>No hay candidatos válidos para la Puta.</p>`;
          } else {
            const optP = possible.map(pl => `<option value="${pl.id}">${pl.name}</option>`).join('');
            inner += `<p>Elige con quién se acostará la Puta (${putaPlayer.name}) esta noche:</p>
                      <select id="target">${optP}</select>`;
          }
        } else {
          inner += `<p>La Puta que controlas ya no está disponible.</p>`;
          player.pimpId = null;
        }
      } else {
        inner += `<p>No controlas a ninguna Puta actualmente.</p>`;
      }
      break;
    case 'Bartender':
      inner += `<p>Elige a quién tomará un trago al amanecer:</p>
                <select id="target">${opts}</select>`;
      break;
    case 'Dealer':
      const dealerOptions = aliveTargets.filter(pl => pl.id !== player.dealerLastTarget);
      if (dealerOptions.length === 0) {
        inner += `<p>No hay candidatos válidos para drogar.</p>`;
      } else {
        const optD = dealerOptions.map(pl => `<option value="${pl.id}">${pl.name}</option>`).join('');
        inner += `<p>Elige a quién drogar (no puedes repetir 2 noches seguidas):</p>
                  <select id="target">${optD}</select>`;
      }
      break;
    case 'Hidratador':
      inner += `<p>Elige a quién hidratar (no tomará su próximo trago):</p>
                <select id="target">${opts}</select>`;
      break;
    default:
      inner += `<p>No tienes acción esta noche.</p>`;
  }

  const html = `<div class="card">
                  ${inner}
                  <button id="btnConfirm"><i class="fas fa-check"></i> Confirmar</button>
                </div>`;
  setScreen(html);
  
  document.getElementById('btnConfirm').onclick = () => {
    const sel = document.getElementById('target');
    const targetId = sel ? parseInt(sel.value) : null;
    
    switch (player.role) {
      case 'Asesino':
        if (targetId !== null) {
          game.assassinVotes[player.id] = targetId;
        }
        break;
      case 'Policía':
        if (targetId !== null) {
          game.nightActions.arrests.push({ officerId: player.id, targetId });
          game.nightSummaryData.arrests.push({
            officer: player,
            target: getPlayer(targetId)
          });
        }
        break;
      case 'Ladrón':
        if (!player.thiefUsed && targetId !== null) {
          if (targetId === -1) {
            // No robar ahora
          } else {
            const victim = getPlayer(targetId);
            if (victim.role === "Policía" || victim.role === "Investigador") {
              game.nightActions.arrests.push({ officerId: null, targetId: player.id }); 
              game.nightSummaryData.arrests.push({
                officer: null,
                target: player,
                reason: 'intento de robo a policía/investigador'
              });
              player.thiefUsed = true;
              log(`¡${player.name} (Ladrón) intentó robar a ${victim.name} (${victim.role}) y fue arrestado!`);
            } else {
              player.stolenRole = victim.role;
              player.role = victim.role;
              player.thiefUsed = true;
              game.nightActions.swaps.push({ thiefId: player.id, targetId: victim.id });
              game.nightSummaryData.swaps.push({
                thief: player,
                victim: victim,
                stolenRole: victim.role
              });
            }
          }
        }
        break;
      case 'Investigador':
        if (!player.investigatorUsed && targetId !== null) {
          const victim = getPlayer(targetId);
          alert(`El rol de ${victim.name} es ${getPublicRole(victim.role)}.`);
          player.role = "Policía";
          player.investigatorUsed = true;
        }
        break;
      case 'Médico':
        if (targetId !== null) {
          game.nightActions.protects.push({ doctorId: player.id, targetId });
          player.medicoLastTarget = targetId;
        }
        break;
      case 'Puta':
        if (targetId !== null) {
          player.lastPartnerId = targetId;
          const partner = getPlayer(targetId);
          const isAsesino = partner.role === "Asesino";
          const isChulo = partner.role === "Chulo";
          
          if (isAsesino) {
            player.infected = true;
            partner.delayedInfection = true;
            partner.infectedRound = game.round;
          }
          
          if (isChulo) {
            player.pimpControlled = true;
            partner.pimpId = player.id;
            log(`${player.name} se acostó con el Chulo. ¡Ahora el Chulo controla sus acciones!`);
          }
          
          if (partner.role === "Suicida") {
            partner.inLoveWith = player.id;
          }
          
          game.nightSummaryData.puta = {
            puta: player,
            target: partner,
            isAsesino: isAsesino,
            isChulo: isChulo
          };
        }
        break;
      case 'Chulo':
        if (targetId !== null && player.pimpId !== null) {
          const putaPlayer = getPlayer(player.pimpId);
          if (putaPlayer && putaPlayer.status === 'vivo') {
            putaPlayer.lastPartnerId = targetId;
            const partner = getPlayer(targetId);
            const isAsesino = partner.role === "Asesino";
            
            if (isAsesino) {
              putaPlayer.infected = true;
              partner.delayedInfection = true;
              partner.infectedRound = game.round;
            }
            
            if (partner.role === "Suicida") {
              partner.inLoveWith = putaPlayer.id;
            }
            
            game.nightSummaryData.puta = {
              puta: putaPlayer,
              target: partner,
              isAsesino: isAsesino,
              controlledBy: player.name
            };
          }
        }
        break;
      case 'Bartender':
        if (targetId !== null) {
          game.nightActions.bartender = targetId;
          game.nightSummaryData.bartender = {
            bartender: player,
            target: getPlayer(targetId)
          };
        }
        break;
      case 'Dealer':
        if (targetId !== null) {
          const target = getPlayer(targetId);
          target.drugged = true;
          player.dealerLastTarget = targetId;
          game.nightActions.dealer = targetId;
          game.nightSummaryData.dealer = {
            dealer: player,
            target: target
          };
        }
        break;
      case 'Hidratador':
        if (targetId !== null) {
          const target = getPlayer(targetId);
          target.hydrated = true;
          game.nightSummaryData.hydrator = {
            hydrator: player,
            target: target
          };
        }
        break;
    }
    callback();
  };
}


/* -------------------- INICIO DE NOCHE -------------------- */
function startNightPhase() {
  if (checkWinConditions()) return;
  game.round++;
  game.phase = 'night';
  game.nightActions = { kills: [], protects: [], swaps: [], bartender: null, arrests: [], dealer: null, hydrator: null };
  game.drinkEvents = []; // Inicializar eventos de tragos
  game.assassinVotes = {}; // Reiniciar votos de asesinos
  game.nightSummaryData = {
    kills: [],
    arrests: [],
    bartender: null,
    dealer: null,
    puta: null,
    swaps: [],
    hydrator: null
  };
  
  // Resetear estados temporales
  game.players.forEach(p => {
    p.drugged = false;
    p.hydrated = false; // Se resetea cada noche
  });
  
  log(`<span class="neon">--- Noche ${game.round} ---</span>`);
  const html = `
    <div class="card">
      <h2><i class="fas fa-moon"></i> Noche ${game.round}</h2>
      <button id="btnNext"><i class="fas fa-arrow-right"></i> Comenzar turnos nocturnos</button>
    </div>`;
  setScreen(html);
  document.getElementById('btnNext').onclick = () => nightTurn(0);
}

/* -------------------- TURNOS NOCTURNOS -------------------- */
function nightTurn(idx) {
  if (idx >= game.players.length) { 
    nightSummary();
    return;
  }
  
  const p = game.players[idx];
  if (p.status !== 'vivo') { nightTurn(idx + 1); return; }

  // Confirmación del votante
  showConfirmPlayer(p, () => {
    // Filtros especiales para diferentes roles
    let aliveTargets = game.players.filter(pl => 
      pl.status === 'vivo' && 
      pl.id !== p.id
    );
    
    // Para asesinos: no pueden atacar a otros asesinos
    if (p.role === 'Asesino') {
      aliveTargets = aliveTargets.filter(pl => pl.role !== 'Asesino');
    }
    
    // Para dealer: no puede drogar al mismo objetivo dos noches seguidas
    if (p.role === 'Dealer') {
      aliveTargets = aliveTargets.filter(pl => pl.id !== p.dealerLastTarget);
    }
    
    // Para puta: no puede repetir pareja
    if (p.role === 'Puta') {
      aliveTargets = aliveTargets.filter(pl => pl.id !== p.lastPartnerId);
    }
    
    const opts = aliveTargets.map(pl => `<option value="${pl.id}">${pl.name}</option>`).join('');
    let inner = `<p>Es tu turno, <strong>${p.name}</strong> <span class="role-badge">${getPublicRole(p.role)}</span>.</p>`;

    // Obtener asesinos vivos
    const aliveAssassins = game.players.filter(
      pl => pl.role === "Asesino" && pl.status === "vivo" && pl.id !== p.id
    );
    const numAssassins = aliveAssassins.length + 1; // +1 por el jugador actual

    switch (p.role) {
      case 'Asesino':
        // Obtener compañeros asesinos VIVOS (incluyendo al jugador actual)
    const aliveAssassins = game.players.filter(
        pl => pl.role === "Asesino" && pl.status === "vivo"
    );
    const numAssassins = aliveAssassins.length;
    
    // Mostrar siempre la lista de compañeros
    let assassinInfo = `<p>Tus compañeros asesinos vivos son: <strong>${aliveAssassins.map(a => a.name).join(', ')}</strong></p>`;
        // Mostrar votos actuales si hay otros asesinos
        let voteInfo = '';
        if (numAssassins > 1) {
          // Contar votos actuales
          const voteCounts = {};
          Object.values(game.assassinVotes).forEach(targetId => {
            voteCounts[targetId] = (voteCounts[targetId] || 0) + 1;
          });
          
          voteInfo = `<div class="assassin-vote">
            <h3>Consejo de Asesinos</h3>
            <p>Hay ${numAssassins} asesinos en juego. Cada uno vota en su turno.</p>
            <div class="vote-count">`;
            
          // Mostrar votos de otros asesinos (sin nombres)
          for (const [targetId, count] of Object.entries(voteCounts)) {
            const target = getPlayer(parseInt(targetId));
            voteInfo += `
              <div class="${game.assassinVotes[p.id] == targetId ? 'selected' : ''}">
                <div class="vote-target">${target.name}</div>
                <div>Votos: ${count}</div>
              </div>`;
          }
          
          voteInfo += `</div></div>`;
        }
        
        inner += `${assassinInfo}${voteInfo}<p>Elige a quién quieres asesinar:</p>
              <select id="target">${opts}</select>`;
    break;
      case 'Policía':
        inner += `<p>Elige a quién arrestarás mañana (no conoces a otros policías):</p>
                  <select id="target">${opts}</select>`;
        break;
            case 'Ladrón':
        if (p.thiefUsed) {
          if (p.stolenRole) {
            inner += `<p>Ya robaste un rol (${p.stolenRole}). Ahora tienes ese rol.</p>`;
          } else {
            inner += `<p>Ya usaste tu robo. No puedes hacer nada.</p>`;
          }
        } else {
          inner += `<p>Puedes robar un rol ahora o esperar:</p>
                    <select id="target">
                      <option value="-1">No robar ahora</option>
                      ${opts}
                    </select>`;
        }
        break;
      case 'Investigador':
        if (p.investigatorUsed) {
          inner += `<p>Ya investigaste a alguien. No puedes hacer nada.</p>`;
        } else {
          inner += `<p>Elige a quién revelarás su rol (una sola vez). Luego serás Policía.</p>
                    <select id="target">${opts}</select>`;
        }
        break;
      case 'Médico':
        // Permitir protegerse a sí mismo, pero no dos veces seguidas
        let medicTargets = game.players.filter(pl => 
          pl.status === 'vivo' && 
          // Si la noche anterior se protegió a sí mismo, excluirse ahora
          (p.medicoLastTarget === null || pl.id !== p.medicoLastTarget)
        );
        
        if (medicTargets.length === 0) {
          inner += `<p>No hay objetivos válidos disponibles para proteger.</p>`;
        } else {
          const opts = medicTargets.map(pl => 
            `<option value="${pl.id}" ${pl.id === p.id ? 'selected' : ''}>${pl.name}${pl.id === p.id ? ' (tú mismo)' : ''}</option>`
          ).join('');
          
          inner += `<p>Elige a quién protegerás esta noche:</p>
                    <select id="target">${opts}</select>`;
        }
        break;
      case 'Puta':
        if (p.status === 'preso') {
          const otherPrisoners = game.players.filter(
            pl => pl.status === 'preso' && pl.id !== p.id
          );
          
          if (otherPrisoners.length > 0) {
            const randomPartner = otherPrisoners[Math.floor(Math.random() * otherPrisoners.length)];
            p.lastPartnerId = randomPartner.id;
            const partner = getPlayer(randomPartner.id);
            
            // AÑADIR ESTAS VERIFICACIONES
            const isAsesino = partner.role === "Asesino";
            const isChulo = partner.role === "Chulo"; // Nueva verificación
            
            if (isAsesino) {
              p.infected = true;
              // El Asesino se marca para morir al final de la PRÓXIMA noche
              partner.delayedInfection = true;
              partner.infectedRound = game.round; // Guardar la ronda de infección
    
              // Mensaje actualizado
              log(`${p.name} se acostó con ${partner.name} (Asesino) → ${p.name} muere por VIH. El Asesino se infecta pero podrá actuar una noche más.`);
            }
            
            // ESTABLECER CONTROL SI ES Chulo
            if (isChulo) {
              p.pimpControlled = true;
              partner.pimpId = p.id;
              log(`${p.name} se acostó con el Chulo. ¡Ahora el Chulo controla sus acciones!`);
            }
            
            game.nightSummaryData.puta = {
              puta: p,
              target: partner,
              isAsesino: isAsesino,
              isChulo: isChulo // Añadir este dato al resumen
            };
            
            log(`${p.name} (presa) se acostó automáticamente con ${partner.name} (preso)`);
          } else {
            log(`${p.name} (presa) no encontró compañeros en prisión`);
          }
          nightTurn(idx + 1);
          return;
        }

        // Si está controlada por un Chulo, saltar turno
        if (p.pimpControlled) {
          nightTurn(idx + 1);
          return;
        }
        
        const possible = aliveTargets.filter(pl => pl.id !== p.lastPartnerId);
        if (possible.length === 0) {
          inner += `<p>No hay candidatos válidos para acostarse.</p>`;
        } else {
          const optP = possible.map(pl => `<option value="${pl.id}">${pl.name}</option>`).join('');
          inner += `<p>Elige con quién acostarte (no puedes repetir 2 noches seguidas):</p>
                    <select id="target">${optP}</select>`;
        }
        break;
        
      case 'Chulo': // Nuevo caso para Chulo
        if (p.pimpId !== null) {
          const putaPlayer = getPlayer(p.pimpId);
          if (putaPlayer && putaPlayer.status === 'vivo') {
            const possible = aliveTargets.filter(pl => 
              pl.id !== putaPlayer.lastPartnerId && 
              pl.id !== p.id
            );
            
            if (possible.length === 0) {
              inner += `<p>No hay candidatos válidos para la Puta.</p>`;
            } else {
              const optP = possible.map(pl => `<option value="${pl.id}">${pl.name}</option>`).join('');
              inner += `<p>Elige con quién se acostará la Puta (${putaPlayer.name}) esta noche:</p>
                        <select id="target">${optP}</select>`;
            }
          } else {
            inner += `<p>La Puta que controlas ya no está disponible.</p>`;
            p.pimpId = null;
          }
        } else {
          inner += `<p>No controlas a ninguna Puta actualmente.</p>`;
        }
        break;
        
      case 'Bartender':
        inner += `<p>Elige a quién tomará un trago al amanecer:</p>
                  <select id="target">${opts}</select>`;
        break;
      case 'Dealer':
        const dealerOptions = aliveTargets.filter(pl => pl.id !== p.dealerLastTarget);
        if (dealerOptions.length === 0) {
          inner += `<p>No hay candidatos válidos para drogar.</p>`;
        } else {
          const optD = dealerOptions.map(pl => `<option value="${pl.id}">${pl.name}</option>`).join('');
          inner += `<p>Elige a quién drogar (no puedes repetir 2 noches seguidas):</p>
                    <select id="target">${optD}</select>`;
        }
        break;
      case 'Hidratador':
        inner += `<p>Elige a quién hidratar (no tomará su próximo trago):</p>
                  <select id="target">${opts}</select>`;
        break;
      case 'Loco': // El loco ahora actúa automáticamente en la noche
        // Acción automática sin interfaz
        const targets = aliveTargets;
        if (targets.length) {
          const randomTarget = targets[Math.floor(Math.random() * targets.length)];
          game.nightActions.arrests.push({ officerId: p.id, targetId: randomTarget.id });
          game.nightSummaryData.arrests.push({
            officer: p,
            target: getPlayer(randomTarget.id)
          });
        }
        nightTurn(idx + 1);
        return;
      default:
        inner += `<p>No tienes acción esta noche.</p>`;
    }

    const html = `<div class="card">
                    ${inner}
                    <button id="btnConfirm"><i class="fas fa-check"></i> Confirmar</button>
                  </div>`;
    setScreen(html);
    document.getElementById('btnConfirm').onclick = () => {
      const sel = document.getElementById('target');
      const targetId = sel ? parseInt(sel.value) : null;
      
      switch (p.role) {
        case 'Asesino':
          if (targetId !== null) {
            // Registrar voto del asesino
            game.assassinVotes[p.id] = targetId;
          }
          break;
        case 'Policía':
          if (targetId !== null) {
            game.nightActions.arrests.push({ officerId: p.id, targetId });
            game.nightSummaryData.arrests.push({
              officer: p,
              target: getPlayer(targetId)
            });
          }
          break;
        case 'Ladrón':
          if (!p.thiefUsed && targetId !== null) {
            if (targetId === -1) {
              // No robar ahora
            } else {
              const victim = getPlayer(targetId);
              // Verificar si la víctima es policía o investigador
              if (victim.role === "Policía" || victim.role === "Investigador") {
                // Arrestar al ladrón
                game.nightActions.arrests.push({ officerId: null, targetId: p.id }); 
                game.nightSummaryData.arrests.push({
                  officer: null,
                  target: p,
                  reason: 'intento de robo a policía/investigador'
                });
                p.thiefUsed = true;
                log(`¡${p.name} (Ladrón) intentó robar a ${victim.name} (${victim.role}) y fue arrestado!`);
              } else {
                // Robo exitoso
                p.stolenRole = victim.role;
                p.role = victim.role;
                p.thiefUsed = true;
                game.nightActions.swaps.push({ thiefId: p.id, targetId: victim.id });
                game.nightSummaryData.swaps.push({
                  thief: p,
                  victim: victim,
                  stolenRole: victim.role
                });
              }
            }
          }
          break;
        case 'Investigador':
          if (!p.investigatorUsed && targetId !== null) {
            const victim = getPlayer(targetId);
            alert(`El rol de ${victim.name} es ${getPublicRole(victim.role)}.`);
            p.role = "Policía";
            p.investigatorUsed = true;
          }
          break;
        case 'Médico':
          if (targetId !== null) {
            game.nightActions.protects.push({ doctorId: p.id, targetId });
            // Guardar el último objetivo protegido
            p.medicoLastTarget = targetId;
          }
          break;
        case 'Puta':
          if (targetId !== null) {
            p.lastPartnerId = targetId;
            const partner = getPlayer(targetId);
            const isAsesino = partner.role === "Asesino";
            const isChulo = partner.role === "Chulo"; // Verificar si es Chulo
            
            if (isAsesino) {
              p.infected = true;
              // Asesino muere en la SIGUIENTE noche
              partner.delayedInfection = true;
              partner.infectedRound = game.round;
            }
            
            // Si es Chulo, establecer control
            if (isChulo) {
              p.pimpControlled = true;
              partner.pimpId = p.id;
              log(`${p.name} se acostó con el Chulo. ¡Ahora el Chulo controla sus acciones!`);
            }
            
            // Si el objetivo es Suicida
            if (partner.role === "Suicida") {
              partner.inLoveWith = p.id;
            }
            
            game.nightSummaryData.puta = {
              puta: p,
              target: partner,
              isAsesino: isAsesino,
              isChulo: isChulo
            };
          }
          break;
          
      case 'Chulo': // Acción del Chulo
        if (targetId !== null && p.pimpId !== null) {
          const putaPlayer = getPlayer(p.pimpId);
          if (putaPlayer && putaPlayer.status === 'vivo') {
            putaPlayer.lastPartnerId = targetId;
            const partner = getPlayer(targetId);
            const isAsesino = partner.role === "Asesino";
            
            if (isAsesino) {
              putaPlayer.infected = true;
              partner.delayedInfection = true;
              partner.infectedRound = game.round;
            }
            
            // Si el objetivo es Suicida
            if (partner.role === "Suicida") {
              partner.inLoveWith = putaPlayer.id;
            }
            
            game.nightSummaryData.puta = {
              puta: putaPlayer,
              target: partner,
              isAsesino: isAsesino,
              controlledBy: p.name
            };
          }
        }
        break;
      case 'Bartender':
        if (targetId !== null) {
          game.nightActions.bartender = targetId;
          game.nightSummaryData.bartender = {
            bartender: p,
            target: getPlayer(targetId)
          };
        }
        break;
      case 'Dealer':
        if (targetId !== null) {
          const target = getPlayer(targetId);
          target.drugged = true;
          p.dealerLastTarget = targetId;
          game.nightActions.dealer = targetId;
          game.nightSummaryData.dealer = {
            dealer: p,
            target: target
          };
        }
        break;
      case 'Hidratador':
        if (targetId !== null) {
          const target = getPlayer(targetId);
          target.hydrated = true;
          game.nightSummaryData.hydrator = {
            hydrator: p,
            target: target
          };
        }
        break;
      default:
        // nada
      }
      // pasar al siguiente jugador de la noche
      nightTurn(idx + 1);
    };
  });
}

/* -------------------- RESUMEN DE LA NOCHE (MODIFICADO) -------------------- */
function nightSummary() {
  // 1️⃣ proteger contra asesinatos
  const protectedSet = new Set(game.nightActions.protects.map(o => o.targetId));
  const deaths = [];

  // 2️⃣ procesar votos de asesinos
  processAssassinVotes(protectedSet, deaths);

  // 3️⃣ Procesar infecciones diferidas de la ronda anterior
  game.players.forEach(p => {
    if (p.delayedInfection && p.infectedRound === game.round - 1) {
      p.status = 'eliminado';
      const drinkAmount = p.drugged ? 
        DRINK_CONFIG[game.difficulty].murder * 2 : 
        DRINK_CONFIG[game.difficulty].murder;
      
      if (p.hydrated) {
        log(`${p.name} estaba hidratado y no toma los ${drinkAmount} tragos por infección diferida.`);
        p.hydrated = false;
      } else {
        p.drinks += drinkAmount;
        addDrinkEvent(`${p.name} debe beber ${drinkAmount} tragos por eliminacion.`);
      }
      
      game.nightSummaryData.kills.push({
        victim: p,
        reason: 'eliminación',
        drinkAmount: drinkAmount
      });
      
      // Comprobar si era Ludópata
      if (p.role === "Ludópata") {
        game.pendingLudopata = p;
      }
      
      p.delayedInfection = false;
    }
  });

  // 4️⃣ infección de la Puta
  game.players.forEach(p => {
    if (p.infected) {
      if (!protectedSet.has(p.id)) {
        // Comprobar si está hidratado
        const drinkAmount = p.drugged ? 
          DRINK_CONFIG[game.difficulty].murder * 2 : 
          DRINK_CONFIG[game.difficulty].murder;
          
        if (p.hydrated) {
          log(`${p.name} estaba hidratado y no toma los ${drinkAmount} tragos por infección.`);
          p.hydrated = false;
        } else {
          p.drinks += drinkAmount;
          addDrinkEvent(`${p.name} debe beber ${drinkAmount} tragos por eliminación.`);
        }
        
        p.status = 'eliminado';
        deaths.push(p);
        game.nightSummaryData.kills.push({
          victim: p,
          reason: 'infección',
          drinkAmount: drinkAmount
        });
        
        // Comprobar si era la Puta y tenía un enamorado (Suicida)
        if (p.role === "Puta") {
          const suicidaInLove = game.players.find(pl => 
            pl.role === "Suicida" && 
            pl.inLoveWith === p.id && 
            pl.status === 'vivo'
          );
          if (suicidaInLove) {
            const drinkAmountSuicida = suicidaInLove.drugged ? 
              DRINK_CONFIG[game.difficulty].elimination * 2 : 
              DRINK_CONFIG[game.difficulty].elimination;
              
            suicidaInLove.status = 'eliminado';
            if (suicidaInLove.hydrated) {
              log(`${suicidaInLove.name} estaba hidratado y no toma los ${drinkAmountSuicida} tragos por amor.`);
              suicidaInLove.hydrated = false;
            } else {
              suicidaInLove.drinks += drinkAmountSuicida;
              addDrinkEvent(`${suicidaInLove.name} debe beber ${drinkAmountSuicida} tragos por eliminación.`);
            }
            game.nightSummaryData.kills.push({
              victim: suicidaInLove,
              reason: 'muerte de amor',
              drinkAmount: drinkAmountSuicida
            });
          }
        }
      } else {
        log(`Un jugador fue protegido y sobrevivió al ataque de los asesinos.`);
      }
      p.infected = false;
    }
  });

  // 5️⃣ bartender (solo nota)
  if (game.nightActions.bartender !== null) {
    const target = getPlayer(game.nightActions.bartender);
    const drinkAmount = target.drugged ? 
      DRINK_CONFIG[game.difficulty].bartender * 2 : 
      DRINK_CONFIG[game.difficulty].bartender;
      
    if (target.hydrated) {
      log(`${target.name} estaba hidratado y no toma el trago del Bartender.`);
      target.hydrated = false;
    } else {
      target.drinks += drinkAmount;
      addDrinkEvent(`${target.name} debe beber ${drinkAmount} tragos por el Bartender.`);
    }
  }

  // Mostrar resumen simplificado (solo tragos)
  let summaryHTML = `<div class="card"><h2><i class="fas fa-moon"></i> Resumen de la Noche ${game.round}</h2>`;
  
  if (game.drinkEvents.length > 0) {
    summaryHTML += `<div class="drink-section">
               <h3>¡Tragos a beber!</h3>
               <ul class="drink-list">`;
    game.drinkEvents.forEach(e => summaryHTML += `<li class="drink-item"><span class="drink-icon-large">🍹</span><span class="drink-text">${e}</span></li>`);
    summaryHTML += `</ul></div>`;
  } else {
    summaryHTML += `<p>No hay tragos asignados esta noche.</p>`;
  }
  
  summaryHTML += `<button id="btnNextDay"><i class="fas fa-sun"></i> Continuar al día</button>`;
  summaryHTML += `</div>`;
  
  setScreen(summaryHTML);

  document.getElementById('btnNextDay').onclick = () => {
    if (checkWinConditions()) return;
    if (game.pendingLudopata) {
      activateLudopataAbility(game.pendingLudopata);
    } else {
      if (game.difficulty === 'alcoholico') {
        medusaEvent();
      } else {
        startDayPhase();
      }
    }
  };
}

function processAssassinVotes(protectedSet, deaths) {
  // En processAssassinVotes, permitir que asesinos infectados voten
const aliveAssassins = game.players.filter(p => 
  p.role === 'Asesino' && 
  (p.status === 'vivo' || p.delayedInfection) // Incluir infectados diferidos
);
  // Si no hay asesinos vivos, no hacemos nada
  if (aliveAssassins.length === 0) return;
  
  // Contar votos
  const voteCounts = {};
  Object.values(game.assassinVotes).forEach(targetId => {
    voteCounts[targetId] = (voteCounts[targetId] || 0) + 1;
  });
  
  // Encontrar el objetivo con más votos
  const maxVotes = Math.max(...Object.values(voteCounts), 0);
  const topTargets = Object.keys(voteCounts).filter(id => voteCounts[id] === maxVotes);
  
  // Si hay un único objetivo con más votos, se asesina
  if (topTargets.length === 1) {
    const targetId = parseInt(topTargets[0]);
    const victim = getPlayer(targetId);
    
    // Verificar si el objetivo está protegido
    if (!protectedSet.has(targetId) && victim.status === 'vivo') {
      playSound('asesinoSound'); // SONIDO DE ASESINATO
      
      victim.status = 'eliminado';
      const drinkAmount = victim.drugged ? 
        DRINK_CONFIG[game.difficulty].murder * 2 : 
        DRINK_CONFIG[game.difficulty].murder;
      
      // Comprobar hidratado
      if (victim.hydrated) {
        log(`${victim.name} estaba hidratado y no toma los ${drinkAmount} tragos por asesinato.`);
        victim.hydrated = false;
      } else {
        victim.drinks += drinkAmount;
        addDrinkEvent(`${victim.name} debe beber ${drinkAmount} tragos por eliminación.`);
      }
      
      deaths.push(victim);
      game.nightSummaryData.kills.push({
        victim: victim,
        drinkAmount: drinkAmount
      });
      
      // Comprobar si era Ludópata
      if (victim.role === "Ludópata") {
        game.pendingLudopata = victim;
      }
      
      // Comprobar si era la Puta y tenía un enamorado (Suicida)
      if (victim.role === "Puta") {
        const suicidaInLove = game.players.find(pl => 
          pl.role === "Suicida" && 
          pl.inLoveWith === victim.id && 
          pl.status === 'vivo'
        );
        if (suicidaInLove) {
          const drinkAmountSuicida = suicidaInLove.drugged ? 
            DRINK_CONFIG[game.difficulty].elimination * 2 : 
            DRINK_CONFIG[game.difficulty].elimination;
            
          suicidaInLove.status = 'eliminado';
          if (suicidaInLove.hydrated) {
            log(`${suicidaInLove.name} estaba hidratado y no toma los ${drinkAmountSuicida} tragos por amor.`);
            suicidaInLove.hydrated = false;
          } else {
            suicidaInLove.drinks += drinkAmountSuicida;
            addDrinkEvent(`${suicidaInLove.name} debe beber ${drinkAmountSuicida} tragos por eliminación.`);
          }
          game.nightSummaryData.kills.push({
            victim: suicidaInLove,
            reason: 'muerte de amor',
            drinkAmount: drinkAmountSuicida
          });
        }
      }
    } else if (victim.status === 'vivo') {
      log(`Un jugador fue protegido y sobrevivió al ataque de los asesinos.`);
    }
  } else if (topTargets.length > 1) {
    log(`Los asesinos no se pusieron de acuerdo (empate en votos). Nadie fue asesinado.`);
  }
}

/* -------------------- INICIO DE DÍA (CON ARRESTOS) -------------------- */
function startDayPhase() {
  if (checkWinConditions()) return;
  game.phase = 'day';
  game.dayArrests = [];
  game.dayVotes = [];
  game.drinkEvents = []; // Inicializar eventos de tragos
  log(`<span class="neon">--- Día ${game.round} ---</span>`);
  
  // Aplicar arrestos planeados en la noche
  applyNightArrests();
  
  const html = `<div class="card"><h2><i class="fas fa-sun"></i> Día ${game.round}</h2>
                <button id="btnVoting"><i class="fas fa-vote-yea"></i> Iniciar votación</button></div>`;
  setScreen(html);
  document.getElementById('btnVoting').onclick = () => startVoting(0);
}

/* -------------------- APLICAR ARRESTOS NOCTURNOS (MODIFICADO) -------------------- */
function applyNightArrests() {
  game.nightActions.arrests.forEach(a => {
    const target = getPlayer(a.targetId);
    if (target.status !== 'vivo') return;
    
    // Caso especial: El menor
    if (target.role === 'El menor') {
      target.status = 'preso';
      target.detainedRounds = 2; // CAMBIO: de 3 a 2 fases (día + noche)
      target.willBecomeAssassin = true;
      const drinkAmount = target.drugged ? 
        DRINK_CONFIG[game.difficulty].arrest * 2 : 
        DRINK_CONFIG[game.difficulty].arrest;
      
      if (target.hydrated) {
        log(`${target.name} estaba hidratado y no toma los ${drinkAmount} tragos por arresto.`);
        target.hydrated = false;
      } else {
        target.drinks += drinkAmount;
        addDrinkEvent(`${target.name} debe beber ${drinkAmount} tragos por arresto.`);
      }
      // CAMBIO: Mensaje actualizado a 2 fases
      log(`${target.name} fue arrestado y cumplirá 2 fases de detención (día y noche).`);
      return;
    }
    
    if (target.role === 'Suicida') {
      target.status = 'eliminado';
      const drinkAmount = target.drugged ? 
        DRINK_CONFIG[game.difficulty].elimination * 2 : 
        DRINK_CONFIG[game.difficulty].elimination;
      
      // Comprobar hidratado
      if (target.hydrated) {
        log(`${target.name} estaba hidratado y no toma los ${drinkAmount} tragos por suicidio.`);
        target.hydrated = false;
      } else {
        target.drinks += drinkAmount;
        addDrinkEvent(`${target.name} debe beber ${drinkAmount} tragos por eliminación.`);
      }
      log(`<div class="eliminated">${target.name} <span class="role">(era ${getPublicRole(target.role)})</span> fue eliminado por votación.</div>`);
    } else {
      target.status = 'preso';
      target.detainedRounds = 2; // CAMBIO: de 3 a 2 fases (día + noche)
      const drinkAmount = target.drugged ? 
        DRINK_CONFIG[game.difficulty].arrest * 2 : 
        DRINK_CONFIG[game.difficulty].arrest;
      
      // Comprobar hidratado
      if (target.hydrated) {
        log(`${target.name} estaba hidratado y no toma los ${drinkAmount} tragos por arresto.`);
        target.hydrated = false;
      } else {
        target.drinks += drinkAmount;
        addDrinkEvent(`${target.name} debe beber ${drinkAmount} tragos por arresto.`);
      }
      
      if (checkWinConditions()) return true;
      // CAMBIO: Mensaje actualizado a 2 fases
      log(`${target.name} ha sido arrestado y cumplirá 2 fases de detención (día y noche).`);
    }
  });
  
  // Actualizar presos al inicio del día
  updatePrisonersAtStartOfDay();
  
  // Mostrar eventos de tragos por arrestos
  if (game.drinkEvents.length > 0) {
    const html = `<div class="card">
                    <h3>Resultados de los arrestos</h3>
                    <div class="drink-section">
                      <h3>¡Tragos a beber!</h3>
                      <ul class="drink-list">`;
    const drinksHTML = game.drinkEvents.map(e => `<li class="drink-item"><span class="drink-icon-large">🍸</span><span class="drink-text">${e}</span></li>`).join('');
    setScreen(`<div id="playerList"></div>${html}${drinksHTML}</ul></div></div>`);
    renderPlayerList();
  }
}

/* -------------------- ACTUALIZAR PRESOS AL INICIO DEL DÍA (MODIFICADO) -------------------- */
function updatePrisonersAtStartOfDay() {
  game.players.forEach(p => {
    if (p.status === 'preso') {
      // Reducir contador de detención
      p.detainedRounds--;
      
      // En nivel Alcoholico, beber en la noche para salir
      if (game.difficulty === 'alcoholico' && p.detainedRounds === 1) {
        const drinkAmount = 1;
        if (p.hydrated) {
          log(`${p.name} estaba hidratado y no toma el trago de fianza para salir.`);
          p.hydrated = false;
        } else {
          p.drinks += drinkAmount;
          addDrinkEvent(`${p.name} debe beber ${drinkAmount} trago de fianza para salir.`);
        }
      }
      
      // Si el contador llega a cero, liberar al jugador
      if (p.detainedRounds <= 0) {
        if (p.willBecomeAssassin) {
          p.role = "Asesino";
          p.willBecomeAssassin = false;
          log(`${p.name} cumplió su detención y se convirtió en asesino.`);
        } else if (p.originalRole === "Ladrón" && p.thiefUsed) {
    // Ladrón pierde su habilidad después de salir de prisión
    p.role = "Ciudadano";
    log(`${p.name} (ex-Ladrón) perdió su habilidad al salir de prisión y ahora es un Ciudadano.`);
        }
        else {
          log(`${p.name} cumplió su detención y vuelve al juego.`);
        }
        
        
        p.status = 'vivo';

      } else {
        // CAMBIO: Mensaje actualizado
        log(`${p.name} permanece en prisión. Falta 1 fase.`);
      }
      
    }
  });
  
}

/* -------------------- EVENTO LA MEDUSA (ALCOHOLICO) -------------------- */
function medusaEvent() {
  log(`<span class="neon">--- Evento La Medusa ---</span>`);
  
  // Solo jugadores vivos pueden participar
  const alivePlayers = game.players.filter(p => p.status === 'vivo');
  
  // Si hay menos de 2 jugadores vivos, saltar evento
  if (alivePlayers.length < 2) {
    log(`No hay suficientes jugadores para La Medusa.`);
    startDayPhase();
    return;
  }
  
  game.medusaChoices = {};
  medusaTurn(0);
}

function medusaTurn(idx) {
  const alivePlayers = game.players.filter(p => p.status === 'vivo');
  
  if (idx >= alivePlayers.length) {
    resolveMedusaEvent();
    return;
  }
  
  const p = alivePlayers[idx];
  
  showConfirmPlayer(p, () => {
    const options = alivePlayers.filter(pl => pl.id !== p.id)
      .map(pl => `<option value="${pl.id}">${pl.name}</option>`)
      .join('');
    
    const html = `<div class="card">
      <div class="medusa-event">
        <h3>La Medusa</h3>
        <p>Elige a quién quieres matar con la mirada:</p>
        <select id="medusaChoice">${options}</select>
        <button id="btnMedusa"><i class="fas fa-eye"></i> Enviar</button>
      </div>
    </div>`;
    
    setScreen(html);
    
    document.getElementById('btnMedusa').onclick = () => {
      const choiceId = parseInt(document.getElementById('medusaChoice').value);
      game.medusaChoices[p.id] = choiceId;
      log(`${p.name} ha hecho su elección en La Medusa.`);
      medusaTurn(idx + 1);
    };
  });
}

function resolveMedusaEvent() {
  const matches = [];
  const processedPairs = new Set(); // Para evitar duplicados

  // Buscar parejas que se eligieron mutuamente
  Object.entries(game.medusaChoices).forEach(([chooserId, chosenId]) => {
    const chooser = getPlayer(parseInt(chooserId));
    const chosen = getPlayer(chosenId);
    
    // Verificar si el elegido también eligió al que lo eligió
    if (game.medusaChoices[chosenId] === parseInt(chooserId)) {
      // Crear un identificador único para la pareja (sin importar el orden)
      const pairKey = [Math.min(chooserId, chosenId), Math.max(chooserId, chosenId)].join('-');
      
      // Solo procesar si no hemos visto esta pareja antes
      if (!processedPairs.has(pairKey)) {
        processedPairs.add(pairKey);
        matches.push({ player1: chooser, player2: chosen });
        
        if (checkWinConditions()) return;
      }
      
      
    }
  });
  
  // Aplicar tragos a las parejas que hicieron match
  const medusaResults = []; // Almacenar resultados para mostrar
  matches.forEach(pair => {
    const drinkAmount = 1;
    
    if (pair.player1.hydrated) {
      pair.player1.hydrated = false;
    } else {
      pair.player1.drinks += drinkAmount;
    }
    
    if (pair.player2.hydrated) {
      pair.player2.hydrated = false;
    } else {
      pair.player2.drinks += drinkAmount;
    }
    
    // Solo un mensaje por match (no por jugador)
    medusaResults.push({
      player1: pair.player1.name,
      player2: pair.player2.name,
      drinkAmount: drinkAmount
    });
  });
  
  // Si hubo matches, mostrar resumen
  if (medusaResults.length > 0) {
    log(`<span class="neon">Resultados de La Medusa: Se formaron ${medusaResults.length} parejas!</span>`);
    showMedusaResults(medusaResults);
  } else {
    log(`No hubo matches en La Medusa. Nadie bebe.`);
    // SOLUCIÓN: Avanzar a la fase correspondiente
    if (game.phase === 'night') {
      startDayPhase();
    } else {
      if (checkWinConditions()) return;
      startNightPhase();
    }
  }
}

function showMedusaResults(results) {
  playSound('medusaSound'); // SONIDO DE MEDUSA
  
  const html = `
    <div class="card">
      <h2 class="neon" style="font-size: 2.2rem; text-align: center;">¡Resultados de La Medusa!</h2>
      
      <div style="display: flex; flex-direction: column; gap: 1.5rem; margin: 2rem 0;">
        ${results.map(res => `
          <div class="medusa-match" style="
            background: linear-gradient(45deg, rgba(155, 89, 182, 0.3), rgba(100, 65, 165, 0.3));
            border: 2px solid var(--accent-purple);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            animation: pulse 2s infinite ease-in-out;
          ">
            <div style="font-size: 1.8rem; margin-bottom: 1rem;">🥂 ¡MATCH! 🥂</div>
            <div style="font-size: 1.4rem; font-weight: bold;">
              ${res.player1} + ${res.player2}
            </div>
            <div style="font-size: 1.2rem; margin-top: 1rem;">
              Ambos beben <span class="neon" style="font-size: 1.5rem;">${res.drinkAmount}</span> trago(s)
            </div>
          </div>
        `).join('')}
      </div>
      
      <button id="btnContinueMedusa"><i class="fas fa-arrow-right"></i> Continuar</button>
    </div>
  `;
  
  setScreen(html);
  
  // SOLUCIÓN: Avanzar a la fase correspondiente
  document.getElementById('btnContinueMedusa').onclick = () => {
    if (game.phase === 'night') {
      startDayPhase();
    } else {
      if (checkWinConditions()) return;
      startNightPhase();
    }
  };
}

/* -------------------- VOTACIÓN DIARIA -------------------- */
function startVoting(idx) {
  // Solo jugadores vivos pueden votar (los presos no pueden votar)
  const voters = game.players.filter(p => p.status === 'vivo');
  
  if (idx >= voters.length) { 
    tallyVotes(); 
    return;
  }
  
  const v = voters[idx];

  // Confirmación del votante
  showConfirmPlayer(v, () => {
    if (v.role === 'Loco') {
      // Loco vota al azar automáticamente
      const options = game.players.filter(
        p => p.status !== 'eliminado' && p.id !== v.id
      );
      
      if (options.length) {
        // 50% de probabilidad de no votar
        if (Math.random() < 0.5) {
          game.dayVotes.push({ voterId: v.id, targetId: -1 }); // No votar
        } else {
          const randomTarget = options[Math.floor(Math.random() * options.length)];
          game.dayVotes.push({ voterId: v.id, targetId: randomTarget.id });
        }
      } else {
        game.dayVotes.push({ voterId: v.id, targetId: -1 }); // No votar
      }
      startVoting(idx + 1);
      return;
    }

    // Todos los jugadores no eliminados (vivos y presos) pueden ser votados
    const options = game.players.filter(
      p => p.status !== 'eliminado' && p.id !== v.id
    );
    
    const optHTML = `
      <option value="-1">No votar</option>
      ${options.map(p => `<option value="${p.id}">${p.name} ${p.status === 'preso' ? '(Preso)' : ''}</option>`).join('')}
    `;
    
    let roleInfo = '';
    
    // Policías no saben quién es otro policía
    if (v.role === 'Policía') {
      roleInfo = '<p class="muted">(No conoces a otros policías)</p>';
    }
    
    const html = `<div class="card"><h3>${v.name} <span class="role-badge">${getPublicRole(v.role)}</span></h3>
                  ${roleInfo}
                  <p>Elige a quién eliminar o selecciona "No votar":</p>
                  <select id="vote">${optHTML}</select>
                  <button id="btnVote"><i class="fas fa-vote-yea"></i> Votar</button></div>`;
    setScreen(html);
    document.getElementById('btnVote').onclick = () => {
      const targetId = parseInt(document.getElementById('vote').value);
      game.dayVotes.push({ voterId: v.id, targetId });
      startVoting(idx + 1);
    };
  });
}

/* -------------------- TABULACIÓN DE VOTACIONES -------------------- */
function tallyVotes() {
  const tally = {};
  
  // Contar votos (incluyendo la opción de no votar)
  game.dayVotes.forEach(v => { 
    tally[v.targetId] = (tally[v.targetId] || 0) + 1;
  });
  
  // Encontrar el máximo de votos
  const max = Math.max(...Object.values(tally));
  const top = Object.entries(tally).filter(([, c]) => c === max).map(([id]) => parseInt(id));
  
  // Comprobar si la opción "No votar" (-1) está entre las más votadas
  if (top.includes(-1)) {
    // Todos los jugadores (vivos, presos, pero no eliminados) deben beber
    const drinkAmount = DRINK_CONFIG[game.difficulty].tie;
    if (drinkAmount > 0) {
      game.players.filter(p => p.status !== 'eliminado').forEach(p => {
        const amount = p.drugged ? drinkAmount * 2 : drinkAmount;
        if (p.hydrated) {
          log(`${p.name} estaba hidratado y no toma el trago por no votar.`);
          p.hydrated = false;
        } else {
          p.drinks += amount;
        }
      });
      log(`La mayoría decidió no votar a nadie. Todos los jugadores no eliminados deben beber ${drinkAmount} trago(s).`);
      addDrinkEvent(`Todos los jugadores no eliminados deben beber ${drinkAmount} trago(s) por no votar a nadie.`);
    } else {
      log(`La mayoría decidió no votar a nadie. No hay tragos asignados.`);
    }
  } 
    // Si hay un único ganador que no es "No votar"
  else if (top.length === 1 && top[0] !== -1) {
    const eliminated = getPlayer(top[0]);
    eliminated.status = 'eliminado';
    const drinkAmount = eliminated.drugged ? 
      DRINK_CONFIG[game.difficulty].elimination * 2 : 
      DRINK_CONFIG[game.difficulty].elimination;
      
      if (checkWinConditions()) return true;
    
    // Comprobar hidratado
    if (eliminated.hydrated) {
      log(`${eliminated.name} estaba hidratado y no toma los ${drinkAmount} tragos por eliminación.`);
      eliminated.hydrated = false;
    } else {
      eliminated.drinks += drinkAmount;
      addDrinkEvent(`${eliminated.name} debe beber ${drinkAmount} tragos por eliminación.`);
    }
    
    log(`<div class="eliminated">${eliminated.name} <span class="role">(era ${getPublicRole(eliminated.role)})</span> fue eliminado por votación.</div>`);
    
    // Comprobar si era Ludópata
    if (eliminated.role === "Ludópata") {
      game.pendingLudopata = eliminated;
    }
  } 
  // Empate entre jugadores (sin incluir "No votar")
  else if (top.length > 1 && !top.includes(-1)) {
    const drinkAmount = DRINK_CONFIG[game.difficulty].tie;
    if (drinkAmount > 0) {
      // Todos los jugadores vivos toman 1 trago por empate (o 2 si están drogaados)
      game.players.filter(p => p.status === 'vivo').forEach(p => {
        const amount = p.drugged ? drinkAmount * 2 : drinkAmount;
        if (p.hydrated) {
          log(`${p.name} estaba hidratado y no toma el trago por empate.`);
          p.hydrated = false;
        } else {
          p.drinks += amount;
        }
      });
      log(`Empate en la votación. Todos los jugadores vivos beben ${drinkAmount} trago(s).`);
      addDrinkEvent(`Todos los jugadores vivos deben beber ${drinkAmount} trago(s) por empate.`);
    } else {
      log(`Empate en la votación. No hay tragos asignados.`);
    }
  }

  daySummary();
}

/* -------------------- RESUMEN DEL DÍA (MODIFICADO) -------------------- */
function daySummary() {
  // Solo mostrar tragos
  let html = `<div class="card"><h2><i class="fas fa-sun"></i> Resumen del Día ${game.round}</h2>`;
  
  if (game.drinkEvents.length > 0) {
    html += `<div class="drink-section">
               <h3>¡Tragos a beber!</h3>
               <ul class="drink-list">`;
    game.drinkEvents.forEach(e => html += `<li class="drink-item"><span class="drink-icon-large">🍹</span><span class="drink-text">${e}</span></li>`);
    html += `</ul></div>`;
  } else {
    html += `<p>No hay tragos asignados este día.</p>`;
  }
  
  html += `<button id="btnNextNight"><i class="fas fa-moon"></i> Continuar a la Noche ${game.round + 1}</button>`;
  html += `</div>`;
  
  setScreen(html);
  
 document.getElementById('btnNextNight').onclick = () => {
    if (checkWinConditions()) return;
    if (game.pendingLudopata) {
      activateLudopataAbility(game.pendingLudopata);
    } else {
      // En nivel Alcoholico, después del día, evento La Medusa
      if (game.difficulty === 'alcoholico') {
        medusaEvent();
      } else {
        if (checkWinConditions()) return;
        startNightPhase();
      }
    }
  };
}

/* -------------------- HABILIDAD MEJORADA DEL LUDÓPATA -------------------- */
function activateLudopataAbility(deadPlayer) {
   // Obtener elemento de audio
  const spinAudio = document.getElementById('spinSound');
  // Jugadores objetivo: vivos o presos (no eliminados)
  const targets = game.players.filter(p => p.status !== 'eliminado');
  const results = [];
  
  let spinCount = 0;
  
  function spinRoulette() {
    spinCount++;
    
    // Seleccionar ganador real
    const winner = targets[Math.floor(Math.random() * targets.length)];
    
    // Generar una lista de 30 elementos con jugadores aleatorios
    const rouletteItems = Array(30).fill(null).map(() => {
      const randomPlayer = targets[Math.floor(Math.random() * targets.length)];
      return randomPlayer.name;
    });

    // Insertar al ganador en 5 posiciones aleatorias
    const winnerPositions = [];
    for (let i = 0; i < 5; i++) {
      const pos = Math.floor(Math.random() * 30);
      rouletteItems[pos] = winner.name;
      winnerPositions.push(pos);
    }

    // Elegir una posición de parada (una de las que tiene al ganador)
    const stopIndex = winnerPositions[Math.floor(Math.random() * winnerPositions.length)];

    // Altura de cada ítem (debe coincidir con el CSS)
    const itemHeight = 40; // px

    // Calcular la posición para que el elemento ganador quede en el centro
    const centerPosition = 2; // Queremos que el ganador esté en la posición 2 (centro de 5)
    const finalPosition = -(stopIndex * itemHeight) + (centerPosition * itemHeight);

    // Agregar 3 vueltas completas para dar efecto (reducido de 5 a 3)
    const extraSpins = 3;
    const totalHeight = rouletteItems.length * itemHeight;
    const extraDistance = extraSpins * totalHeight;
    const totalPosition = finalPosition - extraDistance;

    const html = `<div class="card">
      <h2>Habilidad del Ludópata</h2>
      <p>${deadPlayer.name} (Ludópata) ha muerto. ¡Se activa la ruleta!</p>
      <p>Giro ${spinCount} de 3: Selecciona un jugador que tomará 1 shot</p>
      
      <div class="ludopata-roulette">
        <div class="roulette-container">
          <div id="rouletteWheel" class="roulette-wheel">
            ${rouletteItems.map((name, idx) => 
              `<div class="roulette-item ${name === winner.name ? 'winner-item' : ''}">${name}</div>`
            ).join('')}
          </div>
          <div class="roulette-result">Resultado: ?</div>
        </div>
        <button id="spinButton" class="spin-button"><i class="fas fa-dice"></i> Girar Ruleta</button>
      </div>
    </div>`;
    
    setScreen(html);
    
    document.getElementById('spinButton').onclick = () => {
      
        // Reproducir sonido
      spinAudio.currentTime = 0;
      spinAudio.play().catch(e => console.log("Error al reproducir sonido:", e));
      const wheel = document.getElementById('rouletteWheel');
      const resultDisplay = document.querySelector('.roulette-result');
      
      // Aplicar la transformación gradualmente
      wheel.style.transition = 'transform 4s cubic-bezier(0.2, 0.8, 0.2, 1)';
      wheel.style.transform = `translateY(${totalPosition}px)`;
      
      // Deshabilitar el botón durante la animación
      document.getElementById('spinButton').disabled = true;
      
      setTimeout(() => {
        // Mostrar el resultado
        resultDisplay.textContent = `Resultado: ${winner.name}`;
        
        // Resaltar el elemento ganador en la ruleta
        const winnerElements = document.querySelectorAll('.roulette-item');
        winnerElements.forEach((el, i) => {
          if (rouletteItems[i] === winner.name) {
            el.classList.add('winner');
          }
        });
        
        // Aplicar trago
        let drinkAmount = 1;
        if (game.difficulty === 'alcoholico') {
          drinkAmount = 2; // En nivel Alcoholico, 2 tragos por giro
        }
        if (winner.drugged) {
          drinkAmount *= 2; // Si está drogado, duplica
        }
        
        if (winner.hydrated) {
          log(`${winner.name} estaba hidratado y no toma el trago del Ludópata.`);
          winner.hydrated = false;
        } else {
          winner.drinks += drinkAmount;
          addDrinkEvent(`${winner.name} debe beber ${drinkAmount} tragos por la habilidad del Ludópata.`);
        }
        
        results.push({
          player: winner,
          drinks: drinkAmount
        });
        
        renderPlayerList();
        
        const resultHTML = `<div class="ludopata-result">
          <h4>Resultado del giro ${spinCount}:</h4>
          <div class="ludopata-result-item">
            <span class="winner">${winner.name}</span>
            <span>+${drinkAmount} trago(s)</span>
          </div>
          <button id="nextSpin">Continuar</button>
        </div>`;
        
        document.querySelector('.ludopata-roulette').innerHTML += resultHTML;
        document.getElementById('nextSpin').onclick = nextStep;
      }, 4100);
    };
  }
  
  function nextStep() {
    if (checkWinConditions()) return;
    if (spinCount < 3) {
      spinRoulette();
    } else {
      showLudopataSummary(results);
    }
  }
  
  function showLudopataSummary(results) {
    let summaryHTML = `<div class="card">
      <h2>Resumen de la Ruleta Ludópata</h2>
      <p>La habilidad de ${deadPlayer.name} ha terminado. Resultados:</p>
      
      <div class="ludopata-result">`;
    
    results.forEach((result, index) => {
      summaryHTML += `<div class="ludopata-result-item">
        <span>Giro ${index + 1}: ${result.player.name}</span>
        <span>+${result.drinks} trago(s)</span>
      </div>`;
    });
    
    summaryHTML += `</div><button id="continueAfterLudopata"><i class="fas fa-arrow-right"></i> Continuar</button></div>`;
    
    setScreen(summaryHTML);
    
    document.getElementById('continueAfterLudopata').onclick = () => {
      // Limpiar pendiente
      game.pendingLudopata = null;
      
      // Continuar con el flujo normal
      if (game.phase === 'night') {
        startDayPhase();
      } else {
        if (checkWinConditions()) return;
        startNightPhase();
      }
    };
  }
  
  // Iniciar primer giro
  spinRoulette();
}

/* -------------------- COMPROBAR VICTORIA -------------------- */
function checkWinConditions() {
  // Solo considerar jugadores vivos para determinar el fin del juego
  const activePlayers = game.players.filter(p => p.status === 'vivo' ||  p.status === 'preso');
  
  // Contar asesinos (tanto vivos como presos)
  const allAssassins = game.players.filter(p => p.role === 'Asesino');
  const activeAssassins = allAssassins.filter(p => p.status === 'vivo');
  
  // Contar buenos vivos
  const goodAlive = activePlayers.filter(p => p.role !== 'Asesino').length;

  // Los buenos ganan si no quedan asesinos activos (vivos)
  if (activeAssassins.length === 0) {
    endGame('good');
    return true;
  }
  
  // Los malos ganan si el número de asesinos vivos es mayor o igual que el número de buenos vivos
  if (goodAlive <= activeAssassins.length) {
    endGame('bad');
    return true;
  }
  
  return false;
}

/* -------------------- FUNCIÓN DE REINICIO -------------------- */
function restartGame() {
  // Resetear estado del juego
  game.numPlayers = savedPlayers.length;
  game.round = 0;
  game.phase = '';
  game.eventLog = [];
  game.nightActions = null;
  game.dayArrests = [];
  game.dayVotes = [];
  game.drinkEvents = [];
  game.assassinVotes = {};
  game.nightSummaryData = null;
  
  // Reconstruir jugadores
  game.players = savedPlayers.map((name, i) => ({
    id: i,
    name: name.trim() || `Jugador ${i + 1}`,
    role: null,
    originalRole: null,
    status: 'vivo',
    detainedRounds: 0,
    lastPartnerId: null,
    thiefUsed: false,
    stolenRole: null,
    investigatorUsed: false,
    infected: false,
    drugged: false,
    dealerLastTarget: null,
    drinks: 0,
    hydrated: false,
    envidiaTargetId: null,
    inLoveWith: null,
    willBecomeAssassin: false,
    pimpControlled: false,
    pimpId: null,
    medicoLastTarget: null,
    delayedInfection: false,
    infectedRound: null
  }));
  
  // Usar configuración de roles guardada
  game.selectedRoles = savedSelectedRoles;
  
  // Volver a asignar roles (mezclados)
  assignRoles();
}

/* -------------------- FIN DEL JUEGO MEJORADO -------------------- */
function endGame(winner) {
  const config = DRINK_CONFIG[game.difficulty];
  const winMsg = winner === 'good' ?
    '¡Los buenos han ganado! Todos los asesinos fueron eliminados o están presos.' :
    '¡Los malos han ganado! El número de asesinos vivos es mayor o igual al de buenos vivos.';

  log(`<span class="neon">--- FIN DEL JUEGO ---</span>`);
  log(winMsg);

  const losingTeam = winner === 'good' ? 
    game.players.filter(p => p.role === "Asesino") : 
    game.players.filter(p => p.role !== "Asesino");
  
  losingTeam.forEach(player => {
    const drinkAmount = config.losingTeam;
    player.drinks += drinkAmount;
    log(`${player.name} (${winner === 'good' ? 'asesino' : 'bueno'}) debe tomar ${drinkAmount} shots por perder.`);
  });
  
  // Calcular quién tomó más tragos
  const topDrinkers = [...game.players].sort((a, b) => b.drinks - a.drinks);
  const maxDrinks = topDrinkers[0].drinks;
  const heavyDrinkers = topDrinkers.filter(p => p.drinks === maxDrinks);
  
  // En nivel Alcoholico, el que menos tragos tomó debe tomar 2 shots extra
  if (game.difficulty === 'alcoholico') {
    const minDrinks = Math.min(...game.players.map(p => p.drinks));
    const lightDrinkers = game.players.filter(p => p.drinks === minDrinks);
    
    lightDrinkers.forEach(p => {
      p.drinks += 2;
      log(`En nivel Alcohólico, ${p.name} (el que menos tragos tomó) debe beber 2 shots extra.`);
    });
  }
  
  // Procesar envidiosos
  const envidosos = game.players.filter(p => p.role === "Envidioso" && p.envidiaTargetId !== undefined);
  envidosos.forEach(env => {
    const target = getPlayer(env.envidiaTargetId);
    if (!target) return;

    if (env.drinks < target.drinks) {
      env.drinks += 2;
      log(`El Envidioso ${env.name} tenía menos tragos que ${target.name}. ${env.name} toma 2 tragos extra.`);
    } else if (env.drinks > target.drinks) {
      target.drinks += 2;
      log(`El Envidioso ${env.name} tenía más tragos que ${target.name}. ${target.name} toma 2 tragos extra.`);
    } else {
      // Empate: ambos toman 1 trago
      env.drinks += 1;
      target.drinks += 1;
      log(`El Envidioso ${env.name} y ${target.name} tenían los mismos tragos. Ambos toman 1 trago extra.`);
    }
  });

  // Mostrar resumen final
  showFinalSummary(winner, heavyDrinkers, maxDrinks);
}

/* -------------------- RESUMEN FINAL DETALLADO -------------------- */
function showFinalSummary(winner, heavyDrinkers, maxDrinks) {
  const winMsg = winner === 'good' ?
    '¡Los buenos han ganado! Todos los asesinos fueron eliminados o están presos.' :
    '¡Los malos han ganado! El número de asesinos vivos es mayor o igual al de buenos vivos.';
  
  const drinkMsg = heavyDrinkers.length > 1 ?
    `Los jugadores que más tomaron: ${heavyDrinkers.map(p => p.name).join(', ')} (${maxDrinks} tragos cada uno)` :
    `El jugador que más tomó: ${heavyDrinkers[0].name} (${maxDrinks} tragos)`;
  
  const html = `<div class="card">
                <h2 class="neon">Fin del juego</h2>
                <p style="font-size:1.2rem; text-align:center;">${winMsg}</p>
                <p style="text-align:center; font-weight:500;">${drinkMsg}</p>
                
                <div class="drink-section">
                  <h3>Resumen completo de la partida</h3>
                  <div class="player-list">
                    ${game.players.map(p => `
                      <div class="player-item">
                        <span class="player-name">
                          <i class="fas fa-user"></i>
                          ${p.name} 
                          <span class="role-badge ${p.role === 'Asesino' ? 'asesino' : 'bueno'}">${getPublicRole(p.role)}</span>
                        </span>
                        <span class="player-drinks">${p.drinks || 0} <span class="drink-icon">🍸</span></span>
                        <span class="player-status status-${p.status}">
                          <i class="fas ${p.status === 'vivo' ? 'fa-heart' : p.status === 'preso' ? 'fa-lock' : 'fa-skull'}"></i>
                          ${p.status}
                        </span>
                      </div>`).join('')}
                  </div>
                </div>
                
                <h3>Historial detallado de eventos</h3>
                <div id="eventLog" style="max-height: 300px; overflow-y: auto;"></div>
                
                <button id="btnRestart" class="secondary"><i class="fas fa-redo"></i> Reiniciar</button></div>`;
  setScreen(html);
  
  // Mostrar todo el log acumulado
  const logEl = document.getElementById('eventLog');
  if (logEl) {
    logEl.innerHTML = game.eventLog.map(e => `<div class="event-entry">${e}</div>`).join('');
  }
  
  document.getElementById('btnRestart').onclick = restartGame;
}

/* -------------------- INICIO -------------------- */
showStartScreen();
/* Prevenir pull-to-refresh en móviles */
let touchStartY = 0;
let isAtTop = false;

document.addEventListener('touchstart', e => {
  touchStartY = e.touches[0].clientY;
  isAtTop = window.scrollY === 0;
}, { passive: true });

document.addEventListener('touchmove', e => {
  if (!isAtTop) return;
  
  const touchY = e.touches[0].clientY;
  const deltaY = touchY - touchStartY;
  
  // Prevenir desplazamiento hacia abajo en la parte superior
  if (deltaY > 0) {
    e.preventDefault();
  }
}, { passive: false });

// Función para reiniciar el juego completamente
function resetGame() {
  gameStarted = false;
  game.numPlayers = 0;
  game.players = [];
  game.round = 0;
  game.phase = '';
  game.eventLog = [];
  game.nightActions = null;
  game.dayArrests = [];
  game.dayVotes = [];
  game.selectedRoles = null;
  game.drinkEvents = [];
  game.assassinVotes = {};
  game.nightSummaryData = null;
  game.pendingLudopata = null;
  game.difficulty = 'girls';
  savedPlayers = [];
  savedSelectedRoles = null;
}

// Inicializar el botón de menú
document.addEventListener('DOMContentLoaded', function() {
  const menuButton = document.getElementById('menuButton');
  const menuText = document.getElementById('menuText');
  const confirmationModal = document.getElementById('confirmationModal');
  const modalCancel = document.getElementById('modalCancel');
  const modalConfirm = document.getElementById('modalConfirm');
  let isExpanded = false;
  
  // Función para expandir/contraer el menú
  function toggleMenu() {
    isExpanded = !isExpanded;
    menuButton.classList.toggle('expanded', isExpanded);
  }
  
  // Al hacer clic en el botón (icono)
  menuButton.addEventListener('click', function(e) {
    // Solo expandir si se hizo clic en el icono, no en el texto
    if (!e.target.closest('.menu-text')) {
      toggleMenu();
    }
  });
  
  // Al hacer clic en el texto del menú
  menuText.addEventListener('click', function(e) {
    e.stopPropagation();
    confirmationModal.classList.add('active');
  });
  
  // Botones del modal
  modalCancel.addEventListener('click', function() {
    confirmationModal.classList.remove('active');
  });
  
  modalConfirm.addEventListener('click', function() {
    resetGame();
    showStartScreen();
    confirmationModal.classList.remove('active');
    menuButton.classList.remove('expanded');
    isExpanded = false;
  });
  
  // Cerrar modal al hacer clic fuera
  confirmationModal.addEventListener('click', function(e) {
    if (e.target === confirmationModal) {
      confirmationModal.classList.remove('active');
    }
  });
  
  // Cerrar menú al hacer clic fuera de él
  document.addEventListener('click', function(e) {
    if (isExpanded && !menuButton.contains(e.target)) {
      menuButton.classList.remove('expanded');
      isExpanded = false;
    }
  });
});
</script>

</body>
</html>